<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.3" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png?v=5.1.3">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png?v=5.1.3">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.3" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="crossPQW">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="crossPQW">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="crossPQW">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.3',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>crossPQW</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">crossPQW</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2017/12/11/搬瓦工搭建 SS+多用户配置全攻略/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄少华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="crossPQW">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/12/11/搬瓦工搭建 SS+多用户配置全攻略/" itemprop="url">搬瓦工搭建 SS+多用户配置全攻略</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-12-11T15:39:40+08:00">
                2017-12-11
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/12/11/搬瓦工搭建 SS+多用户配置全攻略/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/12/11/搬瓦工搭建 SS+多用户配置全攻略/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前段时间自己购买的 ss 服务因为众所周知的原因无法使用，用习惯 Google 的再回头用 Baidu 简直像一坨废物，于是自己开始寻思动手搭建 ss 服务器。</p>
<h4 id="安装-Shadowsocks"><a href="#安装-Shadowsocks" class="headerlink" title="安装 Shadowsocks"></a>安装 Shadowsocks</h4><h6 id="VPS-选择"><a href="#VPS-选择" class="headerlink" title="VPS 选择"></a>VPS 选择</h6><p>首先我们需要一台虚拟服务器（VPS）， 我选择了<a href="https://bandwagonhost.com/index.php" target="_blank" rel="noopener">搬瓦工</a>，性价比较高，支持支付宝付款，支持 <code>shadowsockets</code>一键安装，对新手用户比较友好，最主要的是其口碑支持不错，不满意了也可以退款。</p>
<h6 id="套餐选择"><a href="#套餐选择" class="headerlink" title="套餐选择"></a>套餐选择</h6><p>我自己选择的是<code>SPECIAL 20G KVM PROMO V3 - LOS ANGELES - CHINA DIRECT ROUTE</code>套餐，1G RAM，20G 硬盘，每个月2000G 流量，洛杉矶节点，国内直连，完全可以满足我的需求。年付$39,网上搜一下“搬瓦工优惠码”优惠完之后大概折合人民币252/Year左右。</p>
<h6 id="安装-Shadowsocks-Server"><a href="#安装-Shadowsocks-Server" class="headerlink" title="安装 Shadowsocks Server"></a>安装 Shadowsocks Server</h6><p>选择完合适的套餐、注册账号、付款之后，在网站底部点击<code>My Services</code>找到自己购买的服务可以在右边找到<code>KiwiVM Control Panel</code>管理面板的入口。</p>
<p>进入KiwiVM 面板之后，我们可以看到如下页面：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/290760-3b259b7f0cd2999d.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="kiwiVM.jpg"></p>
<p>这里可以看到你的 VPS 所有信息，ip 地址、SSH 端口，运行状态，硬盘流量使用情况等等。<br>在左下角找到<code>Shadowsocks Server</code> 点击进去直接点击<code>Install Shadowsock Server</code>即可一键安装。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/290760-820187e122cc98df.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="SS.jpg"></p>
<p>安装完成后看到这里已经可以使用了，打开你的 SS 客户端，服务器地址为上上图中 <code>IP address</code>，加密方式、端口、密码复制到 SS 客户端中启动即可。</p>
<h4 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h4><p>这时候如果没有太多要求你可以正常访问 Google了，而且速度应该不会太慢，我自己的套餐支持 YouTube 1080P 视频播放。<br>但是我们并不满足，可以进一步优化<code>Shadowsocks</code>x 性能。</p>
<h6 id="连接-VPS"><a href="#连接-VPS" class="headerlink" title="连接 VPS"></a>连接 VPS</h6><p>我自己用的 MacBook Pro，推荐使用 iTerm2来代替系统自带的 Terminal 终端。<br>打开 iTerm按<code>Command + O</code> 选择<code>Edit Profile</code>,新建一个<code>Profile</code>，在<code>Command</code>中填写以下代码<br><code>ssh -A -p 1234 root@1.2.3.4</code><br>其中<code>1234</code>替换为你的搬瓦工 SSH Port，<code>1.2.3.4</code>替换为你的搬瓦工 IP Address。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/290760-4a02af454a0c091e.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="iterm.jpg"></p>
<p>完成后选中新建的 Profile 点击<code>New Window</code>,此时会要求你输入root password，回到<code>KiwiVM面板</code>在左边找到<code>Root password modification</code>即可重置你的密码，重置完成后复制到刚才打开的 iTerm 窗口按<code>Enter</code>即可。</p>
<h6 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h6><ul>
<li>在刚才打开的窗口中，输入如下代码：<br><code>vi /etc/sysctl.d/local.conf</code>创建配置文件。</li>
<li>在打开的 vim 编辑器中，按 <code>i</code> 插入内容</li>
<li>将以下内容复制进去</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"># max open files</span><br><span class="line">fs.file-max = 1024000</span><br><span class="line"># max read buffer</span><br><span class="line">net.core.rmem_max = 67108864</span><br><span class="line"># max write buffer</span><br><span class="line">net.core.wmem_max = 67108864</span><br><span class="line"># default read buffer</span><br><span class="line">net.core.rmem_default = 65536</span><br><span class="line"># default write buffer</span><br><span class="line">net.core.wmem_default = 65536</span><br><span class="line"># max processor input queue</span><br><span class="line">net.core.netdev_max_backlog = 4096</span><br><span class="line"># max backlog</span><br><span class="line">net.core.somaxconn = 4096</span><br><span class="line"></span><br><span class="line"># resist SYN flood attacks</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line"># reuse timewait sockets when safe</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line"># turn off fast timewait sockets recycling</span><br><span class="line">net.ipv4.tcp_tw_recycle = 0</span><br><span class="line"># short FIN timeout</span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line"># short keepalive time</span><br><span class="line">net.ipv4.tcp_keepalive_time = 1200</span><br><span class="line"># outbound port range</span><br><span class="line">net.ipv4.ip_local_port_range = 10000 65000</span><br><span class="line"># max SYN backlog</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 4096</span><br><span class="line"># max timewait sockets held by system simultaneously</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 5000</span><br><span class="line"># TCP receive buffer</span><br><span class="line">net.ipv4.tcp_rmem = 4096 87380 67108864</span><br><span class="line"># TCP write buffer</span><br><span class="line">net.ipv4.tcp_wmem = 4096 65536 67108864</span><br><span class="line"># turn on path MTU discovery</span><br><span class="line">net.ipv4.tcp_mtu_probing = 1</span><br><span class="line"></span><br><span class="line"># for high-latency network</span><br><span class="line">net.ipv4.tcp_congestion_control = hybla</span><br><span class="line"># forward ivp4</span><br><span class="line">net.ipv4.ip_forward = 1</span><br></pre></td></tr></table></figure>
<ul>
<li>按<code>ESC</code>退出编辑，然后按<code>shift</code> + <code>i</code> 输入<code>wq</code>保存退出。</li>
<li>生效以上配置: <code>sysctl --system</code></li>
</ul>
<h4 id="配置多用户"><a href="#配置多用户" class="headerlink" title="配置多用户"></a>配置多用户</h4><p>如果是自己使用的话，以上步骤已经完全可以满足自己使用了，但是往往有这样一个需求：告诉朋友自己搭建了 ss 服务器，朋友问能不能借自己用一下，全部用一个账号又觉得不妥，于是就有了创建多个用户的需求。</p>
<ul>
<li>首先还是跟之前优化性能一样通过 ssh 登录 vps。</li>
<li>创建多用户配置文件：<code>vi /etc/shadowsocks.json</code></li>
<li>按 <code>i</code>插入以下内容：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> &quot;server&quot;:&quot;your_server_ip&quot;, </span><br><span class="line"> &quot;local_address&quot;: &quot;127.0.0.1&quot;,</span><br><span class="line"> &quot;local_port&quot;:1080,</span><br><span class="line"> &quot;port_password&quot;: &#123;</span><br><span class="line">      &quot;8381&quot;: &quot;password1&quot;,   </span><br><span class="line">      &quot;8382&quot;: &quot;password2&quot;,</span><br><span class="line">      &quot;8383&quot;: &quot;password3&quot;,</span><br><span class="line">      &quot;8384&quot;: &quot;password4&quot;</span><br><span class="line"> &#125;,</span><br><span class="line"> &quot;timeout&quot;:300,</span><br><span class="line"> &quot;method&quot;:&quot;aes-256-cfb&quot;,</span><br><span class="line"> &quot;fast_open&quot;: false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是<code>shadowsocks.json</code>文件对应的<code>key-value</code>说明：</p>
<table>
<thead>
<tr>
<th>key</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>server</td>
<td>你的搬瓦工 <code>ip  地址</code></td>
</tr>
<tr>
<td>local_address</td>
<td>默认填写<code>127.0.0.1</code>即可</td>
</tr>
<tr>
<td>local_port</td>
<td>搬瓦工 <code>SSH Port</code></td>
</tr>
<tr>
<td>port_password</td>
<td>多个用户，左边<code>key</code>为端口，右边为密码，就是配置 <code>shadowsockets</code>服务器地址时所用端口、密码</td>
</tr>
<tr>
<td>timeout</td>
<td>超时时间，单位秒</td>
</tr>
<tr>
<td>method</td>
<td>加密方式，默认<code>aes-256-cfb</code>,修改加密方式：<a href="https://github.com/shadowsocks/shadowsocks/wiki/Encryption" target="_blank" rel="noopener">Encryption</a></td>
</tr>
<tr>
<td>fast_open</td>
<td><a href="https://github.com/shadowsocks/shadowsocks/wiki/TCP-Fast-Open" target="_blank" rel="noopener">TCP_FASTOPEN</a>，true/false</td>
</tr>
</tbody>
</table>
<ul>
<li>按<code>ESC</code>退出编辑，然后按<code>shift</code> + <code>i</code> 输入<code>wq</code>保存退出。</li>
<li><p>启动多用户配置：</p>
<ul>
<li>前端启动：<code>ssserver -c /etc/shadowsocks.json</code></li>
<li>后端启动：<code>ssserver -c /etc/shadowsocks.json -d start</code></li>
<li>停止：<code>ssserver -c /etc/shadowsocks.json -d stop</code></li>
<li>重启多用户配置：<code>ssserver -c /etc/shadowsocks.json -d restart</code><br>看到下图说明多用户配置已经启动成功，8381、8382、8383分别是我配置的三个用户端口。<br><img src="http://upload-images.jianshu.io/upload_images/290760-796a0e8dcae27a61.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="1512726447219.jpg"></li>
</ul>
</li>
<li><p>设置多用户配置开机自启：</p>
<ul>
<li>输入<code>vi /etc/rc.local</code></li>
<li>找到带有<code>ssserver</code>的一段默认代码，删掉</li>
<li>将以下信息复制进去：<code>ssserver -c /etc/shadowsocks.json -d start</code></li>
<li>按<code>ESC</code>退出编辑，然后按<code>shift</code> + <code>i</code> 输入<code>wq</code>保存退出。</li>
</ul>
</li>
</ul>
<p>至此，多用户配置已经生效，Enjoy It。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/21/使用Realm+YYModel+AFNetworking构建一个简易的app/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄少华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="crossPQW">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/21/使用Realm+YYModel+AFNetworking构建一个简易的app/" itemprop="url">使用Realm+YYModel+AFNetworking构建一个简易的app</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-21T15:39:40+08:00">
                2016-10-21
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/10/21/使用Realm+YYModel+AFNetworking构建一个简易的app/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/10/21/使用Realm+YYModel+AFNetworking构建一个简易的app/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前写了一篇<a href="https://crosspqw.github.io/2016/10/19/%E4%BD%BF%E7%94%A8Realm%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93/" target="_blank" rel="noopener">使用Realm的一些总结</a>的文章，然后里面说会总结一下使用<code>Realm+YYModel+AFNetworking</code>进行项目开发的经验，所以这篇就是啦。</p>
<h3 id="想法"><a href="#想法" class="headerlink" title="想法"></a>想法</h3><p>第一时间想到的就是市面上最常见的展示类应用，api的话我选择了<a href="https://www.v2ex.com/" target="_blank" rel="noopener">V2EX</a>社区的api，简单的用了一个获取所有节点的api(<a href="http://apizza.cc/console/project/037b2e442bfab1e0b07aa664a2d4335d/browse?f=vx" target="_blank" rel="noopener">v2ex社区api文档看这里</a>)，简单的使用<code>UITableView</code>展示所有的节点。最终效果如下如所示：</p>
<p><img src="http://upload-images.jianshu.io/upload_images/290760-ceeb44bcba0542a5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"></p>
<h3 id="开工"><a href="#开工" class="headerlink" title="开工"></a>开工</h3><h5 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h5><ol>
<li>新建项目，使用<code>Cocoapods</code>管理依赖包，添加<code>AFNetworking，Realm，YYModel</code>这三个库，非常基础的东西不多写了。</li>
<li>准备好获取所有节点的api：<code>http://www.v2ex.com/api/nodes/all.json</code>  </li>
</ol>
<h5 id="封装AFNetworking-以下简称AFN"><a href="#封装AFNetworking-以下简称AFN" class="headerlink" title="封装AFNetworking(以下简称AFN)"></a>封装<code>AFNetworking(以下简称AFN)</code></h5><p>由于<code>Realm</code>原生不支持<code>JSON</code>解析，这篇文章也主要是是为了看如果将<code>Realm与YYModel</code>结合使用，但是我还是决定先封装一下HTTP请求。<br>AFN 3.0之后，网络请求的发起主要依赖<code>AFHTTPSessionManager</code>这个类，我们首先自定义一个单例类<code>SessionManager</code> 继承自<code>AFHTTPSessionManager</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;AFNetworking/AFNetworking.h&gt;</span><br><span class="line"></span><br><span class="line">typedef void(^Success)(id data);</span><br><span class="line">typedef void(^Failure)(NSURLSessionDataTask *task, NSError *error);</span><br><span class="line"></span><br><span class="line">@interface SessionManager : AFHTTPSessionManager</span><br><span class="line">+ (instancetype)shareManager;</span><br><span class="line"></span><br><span class="line">//为了篇幅限制只在文章中展示get请求</span><br><span class="line">- (NSURLSessionDataTask *)GETWithUrl:(NSString *)url params:(NSDictionary *)params success:(Success)success failure:(Failure)failure;</span><br><span class="line">+ (NSURLSessionDataTask *)GETWithUrl:(NSString *)url params:(NSDictionary *)params success:(Success)success failure:(Failure)failure;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;SessionManager.h&quot;</span><br><span class="line"></span><br><span class="line">static NSString *const kBaseURL = @&quot;http://www.v2ex.com/api/&quot;;</span><br><span class="line">typedef NS_ENUM(NSInteger, APIMethod) &#123;</span><br><span class="line">    APIMethodGET,</span><br><span class="line">    APIMethodPOST,</span><br><span class="line">    APIMethodPUT,</span><br><span class="line">    APIMethodDELETE,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">@implementation SessionManager</span><br><span class="line">+ (instancetype)shareManager &#123;</span><br><span class="line">    static SessionManager *manager = nil;</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        manager = [[self alloc] init];</span><br><span class="line">    &#125;);</span><br><span class="line">    return manager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (instancetype)init &#123;</span><br><span class="line">    self = [super initWithBaseURL:[NSURL URLWithString:kBaseURL]];</span><br><span class="line">    self.requestSerializer = [AFHTTPRequestSerializer serializer];</span><br><span class="line">    self.responseSerializer = [AFHTTPResponseSerializer serializer];</span><br><span class="line">    self.requestSerializer.timeoutInterval = 30;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//instance method</span><br><span class="line">- (NSURLSessionDataTask *)GETWithUrl:(NSString *)url params:(NSDictionary *)params success:(Success)success failure:(Failure)failure &#123;</span><br><span class="line">    return [self requestWithMethod:APIMethodGET url:url params:params success:success failure:failure];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//class method</span><br><span class="line">+ (NSURLSessionDataTask *)GETWithUrl:(NSString *)url params:(NSDictionary *)params success:(Success)success failure:(Failure)failure &#123;</span><br><span class="line">    return [[self shareManager] GETWithUrl:url params:params success:success failure:failure];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSURLSessionDataTask *)requestWithMethod:(APIMethod)method url:(NSString *)url params:(NSDictionary *)params success:(Success)success failure:(Failure)failure &#123;</span><br><span class="line"></span><br><span class="line">    if (![url hasPrefix:@&quot;http&quot;]) &#123;</span><br><span class="line">        url = [[self class] reponseUrl:url];</span><br><span class="line">    &#125;</span><br><span class="line">    if ([url rangeOfString:@&quot;:id&quot;].length &gt; 0 ) &#123;</span><br><span class="line">        NSAssert(NO, @&quot;路径 「%@」中有需要替换的id&quot;, url);</span><br><span class="line">    &#125;</span><br><span class="line">    NSURLSessionDataTask *task = nil;</span><br><span class="line">    switch (method) &#123;</span><br><span class="line">        case APIMethodGET: &#123;</span><br><span class="line">            task = [self GET:url parameters:params progress:nil success:^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) &#123;</span><br><span class="line">                [self handleTask:task response:responseObject success:success];</span><br><span class="line">            &#125; failure:^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) &#123;</span><br><span class="line">                [self handleTask:task error:error failure:failure];</span><br><span class="line">            &#125;];</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">       //other case</span><br><span class="line">       //...</span><br><span class="line">    &#125;</span><br><span class="line">    return task;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (NSString *)reponseUrl:(NSString *)url&#123;</span><br><span class="line">    NSString *result = url;</span><br><span class="line">    result = [NSString stringWithFormat:@&quot;%@\%@&quot;, kBaseURL, result];</span><br><span class="line">    return  result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - handle response</span><br><span class="line">- (void)handleTask:(NSURLSessionDataTask *)task response:(id)responseOject success:(Success)success &#123;</span><br><span class="line">    if (success) &#123;</span><br><span class="line">        success(responseOject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)handleTask:(NSURLSessionDataTask *)task error:(NSError *)error failure:(Failure)failure&#123;</span><br><span class="line">   //handle error</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>说明一下：我们的请求<code>manager</code>创建的时候，会基于<code>http://www.v2ex.com/api/</code>这个baseUrl创建，习惯<code>RESTful API</code>的对这个也习以为常了，同时在实例化的时候我们使用了<code>requestSerializer 、responseSerializer</code>，并且设置每次请求超时时长为30秒。</p>
<h5 id="封装API"><a href="#封装API" class="headerlink" title="封装API"></a>封装API</h5><p>现在对于AFN的基本封装工作已经完成，接下来只需要搞定每个API了，我们新建一个<code>V2EXAPIManager</code>类继承自刚才的<code>SessionManager</code>，在接口的实现中补全接口：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;SessionManager.h&quot;</span><br><span class="line">#import &lt;AFNetworking.h&gt;</span><br><span class="line">#import &quot;Node.h&quot;</span><br><span class="line"></span><br><span class="line">@interface V2EXAPIManager : SessionManager</span><br><span class="line"></span><br><span class="line">- (NSURLSessionDataTask *)getAllNodeSuccess:(Success)success failurl:(Failure)failure;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;V2EXAPIManager.h&quot;</span><br><span class="line"></span><br><span class="line">static NSString *allNodelUrl = @&quot;nodes/all.json&quot;;</span><br><span class="line"></span><br><span class="line">@implementation V2EXAPIManager</span><br><span class="line"></span><br><span class="line">- (NSURLSessionDataTask *)getAllNodeSuccess:(Success)success failurl:(Failure)failure &#123;</span><br><span class="line">    return [self GETWithUrl:allNodelUrl params:nil success:^(id data) &#123;</span><br><span class="line"></span><br><span class="line">        NSArray &lt;Node*&gt;*allNodes = [NSArray yy_modelArrayWithClass:[Node class] json:data];</span><br><span class="line">        if (success) &#123;</span><br><span class="line">            success(allNodes);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; failure:^(NSURLSessionDataTask *task, NSError *error) &#123;</span><br><span class="line">        if (failure) &#123;</span><br><span class="line">            failure(task,error);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>有了BaseUrl，接下来只需要的发起请求的时候，拼接上具体的需要访问服务器的资源，这里是<code>nodes/all.json</code>。</p>
<h5 id="新建可用于持久化的Node模型"><a href="#新建可用于持久化的Node模型" class="headerlink" title="新建可用于持久化的Node模型"></a>新建可用于持久化的Node模型</h5><p>通过log我们可以看到，得到的是这样json串，映射到iOS中则是一个包含多个字典的数组。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    &quot;id&quot;: 1,</span><br><span class="line">    &quot;name&quot;: &quot;babel&quot;,</span><br><span class="line">    &quot;url&quot;: &quot;http://www.v2ex.com/go/babel&quot;,</span><br><span class="line">    &quot;title&quot;: &quot;Project Babel&quot;,</span><br><span class="line">    &quot;title_alternative&quot;: &quot;Project Babel&quot;,</span><br><span class="line">    &quot;topics&quot;: 1119,</span><br><span class="line">    &quot;header&quot;: &quot;Project Babel - 帮助你在云平台上搭建自己的社区&quot;,</span><br><span class="line">    &quot;footer&quot;: &quot;V2EX 基于 Project Babel 驱动。Project Babel 是用 Python 语言写成的，运行于 Google App Engine 云计算平台上的社区软件。Project Babel 当前开发分支 2.5。最新版本可以从 &lt;a href=\&quot;http://github.com/livid/v2ex\&quot; target=\&quot;_blank\&quot;&gt;GitHub&lt;/a&gt; 获取。&quot;,</span><br><span class="line">    &quot;created&quot;: 1272206882</span><br><span class="line">  &#125;,</span><br><span class="line">  ...</span><br><span class="line">  ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>接下来就是根据拿到的数据字段建立我们的<code>Node</code>模型了,在使用<code>Realm</code>的时候需要我们的数据模型继承自<code>RLMObject</code>，同时为了使用<code>YYModel</code>,我们需要遵循<code>&lt;YYModel&gt;</code>协议:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;Realm/Realm.h&gt;</span><br><span class="line">#import &lt;YYModel/YYModel.h&gt;</span><br><span class="line"></span><br><span class="line">@interface Node : RLMObject&lt;YYModel&gt;</span><br><span class="line"></span><br><span class="line">@property NSString *ID;</span><br><span class="line">@property NSString *name;</span><br><span class="line">@property NSString *url;</span><br><span class="line">@property NSString *title;</span><br><span class="line">@property NSString *title_alternative;</span><br><span class="line">@property NSInteger topics;</span><br><span class="line">@property  NSString *header;</span><br><span class="line">@property  NSString *footer;</span><br><span class="line">@property NSDate *created;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;Node.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation Node</span><br><span class="line"></span><br><span class="line">+ (NSString *)primaryKey &#123;</span><br><span class="line">    return @&quot;ID&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (NSArray&lt;NSString *&gt; *)indexedProperties &#123;</span><br><span class="line">    return @[@&quot;ID&quot;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//由于`id`字段会与系统关键字冲突，我们可以手动转换为大写`ID`</span><br><span class="line">+ (NSDictionary&lt;NSString *,id&gt; *)modelCustomPropertyMapper &#123;</span><br><span class="line">    return @&#123;@&quot;ID&quot;:@&quot;id&quot;&#125;;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>为了方便以后的使用以及提高查询速度，我们使用ID作为主键与索引字段。<br>这样就可以在请求到数据之后使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> NSArray &lt;Node*&gt;*allNodes = [NSArray yy_modelArrayWithClass:[Node class] json:data];</span><br></pre></td></tr></table></figure></p>
<p>直接将数据转换为存放节点<code>Node</code>的数组。</p>
<h5 id="在控制器里面发起请求并持久化"><a href="#在控制器里面发起请求并持久化" class="headerlink" title="在控制器里面发起请求并持久化"></a>在控制器里面发起请求并持久化</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">- (void)getNodes &#123;</span><br><span class="line">    [[V2EXAPIManager shareManager] getAllNodeSuccess:^(id data) &#123;</span><br><span class="line">        NSArray *nodes;</span><br><span class="line">        if ([data isKindOfClass:[NSArray class]]) &#123;</span><br><span class="line">            nodes = data;</span><br><span class="line">        &#125;</span><br><span class="line">        dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^&#123;</span><br><span class="line">            @autoreleasepool &#123;</span><br><span class="line">                //delete old data</span><br><span class="line">                RLMRealm *realm = [RLMRealm defaultRealm];</span><br><span class="line">                [realm beginWriteTransaction];</span><br><span class="line">                [realm deleteAllObjects];</span><br><span class="line">                [realm commitWriteTransaction];</span><br><span class="line">                </span><br><span class="line">                //add new data</span><br><span class="line">                [realm beginWriteTransaction];</span><br><span class="line">                for (Node *node in nodes) &#123;</span><br><span class="line">                    [realm addObject:node];</span><br><span class="line">                &#125;</span><br><span class="line">                [realm commitWriteTransaction];</span><br><span class="line">                </span><br><span class="line">                //retrieve data and reload data in main thread</span><br><span class="line">                dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                    RLMRealm *mainThreadRealm = [RLMRealm defaultRealm];</span><br><span class="line">                    self.nodes = [Node allObjectsInRealm:mainThreadRealm];</span><br><span class="line">                    [self.tableview reloadData];</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125; failurl:^(NSURLSessionDataTask *task, NSError *error) &#123;</span><br><span class="line">        self.nodes = [Node allObjects];</span><br><span class="line">        [self.tableview reloadData];</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其他将数据渲染到UI上的一些代码就不往上贴了，当然，本例也是非的简陋，例如封装请求的错误处理也没有做，也没有多余的UI设计，不过我们可以看到，使用<code>Realm+YYModel</code>完成一个从远程请求数据并在本地持久化的需求非常简单，关键代码甚至没有几行。<br>你可以在<code>GitHub</code>直接<code>clone</code>这个<a href="https://github.com/crossPQW/Realm-YYModel" target="_blank" rel="noopener">Repository</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/10/19/使用Realm的一些总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄少华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="crossPQW">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/10/19/使用Realm的一些总结/" itemprop="url">使用Realm的一些总结</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-19T15:39:40+08:00">
                2016-10-19
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/10/19/使用Realm的一些总结/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/10/19/使用Realm的一些总结/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="为什么我要用realm呢"><a href="#为什么我要用realm呢" class="headerlink" title="为什么我要用realm呢"></a>为什么我要用realm呢</h3><p>前段时间新开了一个项目,在做技术选型的时候,尝试了一下把数据存储这块从<code>FMDB</code>换为<code>Realm</code>,最初的理由就是觉得<code>Realm</code>很酷,后来用了一段时间之后发现自己的选择是明智的:</p>
<ul>
<li><a href="https://realm.io/docs/objc/latest/#getting-started" target="_blank" rel="noopener">文档</a>详细,甚至有中文版,当然中文版更新比较慢.</li>
<li>使用中遇到问题去Stackoverflow基本上都能找到,Realm团队回答也特别快.</li>
<li>查询速度超快(真正实现了懒加载,即用到时才从磁盘中查询).</li>
<li>相比FMDB,API友好到爆炸.</li>
<li>跨平台(我司iOS安卓都用了Realm).</li>
<li>提供了Mac版Realm Browser方便查看数据,Mac app store下载即可.</li>
</ul>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>当然你可以直接下载Realm库拖到项目中,不过由于墙的存在,直接在realm官网下载会比较慢,强烈推荐使用CocoaPods或者Carthage安装,只需要<code>pod &#39;Realm&#39;</code>或者在<code>Cartfile</code>中添加<code>github &quot;realm/realm-cocoa&quot;</code>即可.</p>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><h5 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h5><p>最简单的方式,使用默认配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RLMRealm *realm = [RLMRealm defaultRealm];</span><br></pre></td></tr></table></figure></p>
<p>默认情况下,realm数据库存储在<code>Document</code>路径下,默认数据库文件名字是<code>default.realm</code>,当然你也可以自定义这些选项:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> // 使用默认的目录，但是使用用户名来替换默认的文件名 </span><br><span class="line">RLMRealmConfiguration *config = [RLMRealmConfiguration defaultConfiguration];</span><br><span class="line">config.fileURL = [[[config.fileURL URLByDeletingLastPathComponent]  URLByAppendingPathComponent:@&quot;yourname&quot;] URLByAppendingPathExtension:@&quot;realm&quot;]; </span><br><span class="line">// 将这个配置应用到默认的 Realm 数据库当中</span><br><span class="line"> [RLMRealmConfiguration setDefaultConfiguration:config];</span><br></pre></td></tr></table></figure></p>
<p>默认情况下,realm是基于磁盘缓存的,但是假如我们有时候不想储存数据,又想需要灵活的进行数据读写,这时候我们可以创建一个内存数据库,创建内存数据库同样非常简单:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">RLMRealmConfiguration *config = [RLMRealmConfiguration defaultConfiguration];</span><br><span class="line">//指定inMemoryIdentifier即可</span><br><span class="line">config.inMemoryIdentifier = @&quot;MyInMemoryRealm&quot;;</span><br><span class="line">RLMRealm *realm = [RLMRealm realmWithConfiguration:config error:nil];</span><br></pre></td></tr></table></figure></p>
<p>但是用的时候我们要注意数据库实例被自动释放掉, 这就需要我们在app的生命周期内保持对realm内存数据库的强引用.</p>
<h5 id="构建基于realm的数据model"><a href="#构建基于realm的数据model" class="headerlink" title="构建基于realm的数据model"></a>构建基于realm的数据model</h5><p>构建一个基于realm的数据model非常简单,只需要继承自<code>RLMObject</code>即可,当然你也可以通过Xcode插件直接新建一个Realm class,不过我还是习惯手动创建.<br>以我的项目为例,我们创建一个Book模型:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@interface Book :RLMObject</span><br><span class="line">@property (nonatomic, copy) NSString *ID;</span><br><span class="line">@property (nonatomic, copy) NSString *title;</span><br><span class="line">@property (nonatomic, copy) NSString *cover;</span><br><span class="line">@property (nonatomic, assign) long date;</span><br><span class="line">@property (nonatomic, strong) Day *firstDay;</span><br><span class="line">@property (nonatomic, strong) RLMArray &lt;Day *&gt; *days;</span><br><span class="line">@end</span><br><span class="line">RLM_ARRAY_TYPE(Day)</span><br><span class="line"></span><br><span class="line">@implementation Book</span><br><span class="line">+ (NSString *)primaryKey &#123;</span><br><span class="line">    return @&quot;ID&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//设置属性默认值</span><br><span class="line">+ (NSDictionary *)defaultPropertyValues&#123; </span><br><span class="line">    return @&#123;@&quot;title&quot;:@&quot;测试&quot; &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//设置忽略属性,即不存到realm数据库中</span><br><span class="line">+ (NSArray&lt;NSString *&gt; *)ignoredProperties &#123;</span><br><span class="line">    return @[@&quot;days&quot;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//一般来说,属性为nil的话realm会抛出异常,但是如果实现了这个方法的话,就只有name为nil会抛出异常,也就是说现在cover属性可以为空了</span><br><span class="line">+ (NSArray *)requiredProperties &#123; </span><br><span class="line">    return @[@&quot;name&quot;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//设置索引,可以加快检索的速度</span><br><span class="line">+ (NSArray *)indexedProperties &#123;</span><br><span class="line">    return @[@&quot;ID&quot;];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure></p>
<p>在这个Book模型中,有<code>ID,title,cover,date,days</code>这几个字段,realm支持<code>BOOL,bool,int,NSInteger,long,long long,float,double,NSString,NSDate,NSData</code><br> 以及 <a href="https://realm.io/cn/docs/objc/latest/#optional-properties" target="_blank" rel="noopener">被特殊类型标记的</a> NSNumber这些类型.</p>
<ul>
<li>Tips:如果想存储图片的话,可以把<code>UIImage</code>转为<code>NSData</code>存储,当然Realm限制了单个图片大小为16M,所以最好的测试是手动把图片存储到磁盘,然后Realm只尺寸图片的url,url可以是远程url或者本地的路径.</li>
</ul>
<p>通过<code>days</code>这个字段可以看到realm实现To-One或者To-Many关系很简单,创建一对一关系的话直接定义为property即可,创建一对多关系的话,使用<code>RLM_ARRAY_TYPE</code>宏创建协议,然后定义<code>RLMArray&lt;Day*&gt;</code>类型就行啦.<br>通过<code>primaryKey</code>我们可以给model设置一个主键,这对于我们进行添加数据与更新数据的时候很有帮助,比如我们想要添加或者修改一条数据的话,只需要在事务中操作即可:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Book *book = [[Book alloc] init];</span><br><span class="line">book.ID = @&quot;ABCDEFG&quot;;</span><br><span class="line">book.title = @&quot;威尼斯之行&quot;;</span><br><span class="line">book.cover = @&quot;www.google.com&quot;;</span><br><span class="line">//添加数据</span><br><span class="line">RLMRealm *realm = [RLMRealm defaultRealm];</span><br><span class="line">[realm beginWriteTransaction];</span><br><span class="line">[realm addObject:book];</span><br><span class="line">[realm commitWriteTransaction];</span><br><span class="line"></span><br><span class="line">//修改数据</span><br><span class="line">[realm beginWriteTransaction];</span><br><span class="line">book.title = @&quot;美西之行&quot;;</span><br><span class="line">[realm commitWriteTransaction];</span><br></pre></td></tr></table></figure></p>
<p>如果我们设置了主键(primaryKey),就可以直接这样,直接调用<code>createOrUpdateInRealm:realm</code>函数,如果ID为<code>ABCDEFG</code>的Book对象已经存在,那么对象就会直接更新,如果不存在,就会创建一个,这一点特别像在写rails的时候操作数据库的方法,非常方便<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Book *book = [[Book alloc] init];</span><br><span class="line">book.ID = @&quot;ABCDEFG&quot;;</span><br><span class="line">book.title = @&quot;美西之旅&quot;;</span><br><span class="line">book.cover = @&quot;www.apple.com&quot;;</span><br><span class="line">[realm beginWriteTransaction];</span><br><span class="line">[Book createOrUpdateInRealm:realm withValue:book];</span><br><span class="line">[realm commitWriteTransaction];</span><br><span class="line"></span><br><span class="line">//还可以这样,直接通过键值对进行更新</span><br><span class="line">[realm beginWriteTransaction];</span><br><span class="line">[Book createOrUpdateInRealm:realm withValue:@&#123;@&quot;ID&quot;: @&quot;ABCDEFG&quot;, @&quot;title&quot;: @&quot;美西之旅&quot;&#125;];</span><br><span class="line">[realm commitWriteTransaction];</span><br></pre></td></tr></table></figure></p>
<h3 id="Realm数据库的CURD"><a href="#Realm数据库的CURD" class="headerlink" title="Realm数据库的CURD"></a>Realm数据库的CURD</h3><h5 id="C-create-amp-U-update"><a href="#C-create-amp-U-update" class="headerlink" title="C(create) &amp; U(update)"></a>C(create) &amp; U(update)</h5><p>其实在上面我们已经简单的说过创建跟更新的方法了,一般来说如果你设置了主键的话,会用的最多的基本上就是<code>createOrUpdateInRealm</code>方法,而且项目中我们一般面向对象编程,会把键值对,json等数据使用一些类似<code>Mantle,YYModel</code>的工具转换为对象,所以其他类似于通过字典创建更新数据,支持属嵌套属性(Nested Object)的创建等功能就不多细说了.</p>
<h5 id="R-Retrieve-读取数据"><a href="#R-Retrieve-读取数据" class="headerlink" title="R(Retrieve)读取数据"></a>R(Retrieve)读取数据</h5><p>Realm的数据查询非常强大,基本上接触过<code>谓词NSPredicate</code>之后都可以快速上手,查询的结果存储为<code>RLMResults&lt;model*&gt;</code>的容器,其实这玩意完全可以当做<code>NSArray</code>来用,同样支持下标操作,支持快速遍历,不同的是<code>RLMResult</code>需要指定类型,比如<code>RLMResult&lt;Book*&gt;</code>就是包含多个book的集合,另外我们开篇提到的Realm是懒加载的,也就是说查询到的结果只会在被确定访问某个属性的时候才去读取,否则我们的查询操作将会被延迟执行.<br>接下来我们举几个查询的例子:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//从默认数据库查询所有的书</span><br><span class="line">RLMResults&lt;Book *&gt; *books = [Book allObjects];</span><br><span class="line"></span><br><span class="line">//使用断言字符串查询</span><br><span class="line">RLMResults&lt;Book *&gt; *books = [Book objectsWhere:@&quot;title = &apos;美西之旅 AND cover = &apos;www.apple.com&apos;&apos;&quot;]</span><br><span class="line"></span><br><span class="line">//使用NSPredicate查询</span><br><span class="line">NSPredicate *pred = [NSPredicate predicateWithFormat:@&quot;title = &apos;美西之旅 AND cover = &apos;www.apple.com&apos;&apos;&quot;];</span><br><span class="line">books = [Book objectsWithPredicate:pred];</span><br><span class="line"></span><br><span class="line">//链式查询</span><br><span class="line">RLMResults&lt;Book *&gt; *books = [Book objectsWhere:@&quot;title = &apos;美西之旅&apos;&quot;];</span><br><span class="line">RLMResults&lt;Book *&gt; *otherBooks = [books objectsWhere:@&quot;cover = &apos;www.apple.com&apos;&quot;];</span><br><span class="line"></span><br><span class="line">//排序</span><br><span class="line">//按照data从大到小进行排序</span><br><span class="line">RLMResults&lt;Book *&gt; *sortedBooks = [[Book objectsWhere:@&quot;title = &apos;美西之旅&apos; &quot;] sortedResultsUsingProperty:@&quot;date&quot; ascending:YES];</span><br></pre></td></tr></table></figure></p>
<p>Tips1:有时候我们确实想使用<code>NSArray</code>而不是<code>RLMArray</code>或者<code>RLMResult</code>,我们可以简单的进行遍历转换:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//假设这是我们查询到的结果</span><br><span class="line">RLMResult&lt;Day*&gt;days;</span><br><span class="line">NSMutableArray *array = [NSMutableArray array];</span><br><span class="line">    for (Day *day in days) &#123;</span><br><span class="line">        [array addObject:day];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Tips2:写程序的时候前人一直告诉我们DRY原则(Dont Repeat Yourself),每次写<code>beginWriteTransaction</code>跟<code>commitWriteTransaction</code>也确实很让人烦,我们可以稍微封装一个方法:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (void)update:(void (^)())block &#123;</span><br><span class="line">    [self.realm beginWriteTransaction];</span><br><span class="line">    block();</span><br><span class="line">    [self.realm commitWriteTransaction];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样用的时候就可以这么用:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[book update:^&#123;</span><br><span class="line">     book.cover = @&quot;new cover&quot;;</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p>更多关于断言的使用比如== ,&lt;=,&gt;=,AND,BETWEEN BEGINSWITH等使用方法可以查看<a href="https://realm.io/news/nspredicate-cheatsheet/" target="_blank" rel="noopener">这里的文档</a></p>
<h5 id="D-Delete-删除数据"><a href="#D-Delete-删除数据" class="headerlink" title="D(Delete)删除数据"></a>D(Delete)删除数据</h5><p>在realm中想要删除数据非常简单,假设我们有一个book模型需要删除,只需要:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//删除单条记录</span><br><span class="line">[realm beginWriteTransaction];</span><br><span class="line">[realm deleteObject:book];</span><br><span class="line">[realm commitWriteTransaction];</span><br><span class="line"></span><br><span class="line">//清空realm数据库,清空后Realm文件不会释放掉所占用的空间,这是为了保留空间以便日后提高存储速度</span><br><span class="line">[realm beginWriteTransaction];</span><br><span class="line">[realm deleteAllObjects];</span><br><span class="line">[realm commitWriteTransaction];</span><br></pre></td></tr></table></figure></p>
<p>我们可以看到,大多数操作都是在一个事务中进行的,如果在错误的事务中进行了数据的操作,realm会抛出异常.</p>
<h3 id="Realm中的线程"><a href="#Realm中的线程" class="headerlink" title="Realm中的线程"></a>Realm中的线程</h3><p>首先单个线程中,我们当然无需考虑并发或者多线程处理的问题,也无需考虑线程锁,我们唯一的修改的操作也是在对象自己的realm事务中.<br>需要特别注意的一点是,我们不能让多个线程拥有同一个Realm对象的实例.<br>如果想要跨线程使用数据库的话,我们需要在每个线程都去初始化一个新的Realm实例,如果都是执行的同一个数据库的话,这些实例都是指向磁盘的同一个文件的.<br>Realm官方给了一个结合GCD(大中枢派发233333)大批量写入数据的例子:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">dispatch_async(queue, ^&#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        // 在这个线程中获取 Realm 和表实例</span><br><span class="line">        RLMRealm *realm = [RLMRealm defaultRealm];</span><br><span class="line">        </span><br><span class="line">        // 通过开启写入操作将写入闭包分成多个微小部分</span><br><span class="line">        for (NSInteger idx1 = 0; idx1 &lt; 1000; idx1++) &#123;</span><br><span class="line">            [realm beginWriteTransaction];</span><br><span class="line">            </span><br><span class="line">            // 通过字典插入行，忽略属性次序</span><br><span class="line">            for (NSInteger idx2 = 0; idx2 &lt; 1000; idx2++) &#123;</span><br><span class="line">                [Person createInRealm:realm</span><br><span class="line">                            withValue:@&#123;@&quot;name&quot;      :  randomString,</span><br><span class="line">                                        @&quot;birthdate&quot; : randomDate&#125;];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // 提交写入事务以确保数据在其他线程可用</span><br><span class="line">            [realm commitWriteTransaction];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p>
<h3 id="对JSON的支持"><a href="#对JSON的支持" class="headerlink" title="对JSON的支持"></a>对JSON的支持</h3><p>很遗憾Realm并不直接支持JSON(那你说个卵啊~)…<br>我们可以使用系统自带的系列化函数来序列化JSON数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NSData *data = [@&quot;&#123;\&quot;name\&quot;: \&quot;旧金山\&quot;, \&quot;cityId\&quot;: 123&#125;&quot; dataUsingEncoding: NSUTF8StringEncoding];</span><br><span class="line">[realm transactionWithBlock:^&#123; </span><br><span class="line">    id json = [NSJSONSerialization JSONObjectWithData:data options:0 error:NULL]; </span><br><span class="line">    [City createOrUpdateInRealm:realm withValue:json];&#125;</span><br><span class="line">];</span><br></pre></td></tr></table></figure></p>
<p>当然其实真正的工作中我们一般也不这么来搞,一般会用<code>Mantle,YYModel</code>等其他类似工具将json转换为对象之后直接进行存储,后面我也打算写一些Realm+YYModel的使用心得.</p>
<h3 id="如何查看存储在Realm中的数据"><a href="#如何查看存储在Realm中的数据" class="headerlink" title="如何查看存储在Realm中的数据"></a>如何查看存储在Realm中的数据</h3><p><strong>如果使用模拟器进行调试,可以通过</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[RLMRealmConfiguration defaultConfiguration].fileURL</span><br></pre></td></tr></table></figure></p>
<p>打印出Realm 数据库地址,然后在Finder中<code>⌘⇧G</code>跳转到对应路径下,用Realm Browser打开对应的<code>.realm</code>文件就可以看到数据啦.<br><strong>使用真机调试的话</strong><br>Xcode-&gt;Window-&gt;Devices(<code>⌘⇧2</code>),然后找到对应的设备与项目,点击<code>Download Container</code></p>
<p><img src="http://upload-images.jianshu.io/upload_images/290760-790baece0848503f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Paste_Image.png"><br>导出xcappdata文件后,显示包内容,进到<code>AppData-&gt;Documents</code>,使用<code>Realm Browser</code>打开<code>.realm</code>文件即可.</p>
<h3 id="遇到的一些坑或者不爽的地方"><a href="#遇到的一些坑或者不爽的地方" class="headerlink" title="遇到的一些坑或者不爽的地方"></a>遇到的一些坑或者不爽的地方</h3><p>当然,这么一个还算比较新的工具说是完美的肯定是不可能,我在使用中也在经常地骂娘,虽然后来发现好多是使用姿势不对23333</p>
<ol>
<li>所有的操作都要在事务中,麻烦,不过我们可以像文中tips那样进行小小的封装.</li>
<li>要时刻注意操作的是不是同一个realm实例,不然会crash,crash log中,iOS跟安卓一样,90%的crash都是跟realm有关😭,还要注意对象是否可用,这个我们可以用<code>invalidated</code>字段来判断,也算是防御式编程了23333….</li>
<li>写数据迁移(migrate)不算太友好,不太喜欢,长期下来,迁移的代码画美不看……也可能是自己功力不够,所以文章中自己也没写关于迁移的内容,想要了解的可以看官方的migrate demo,什么时候移动端写数据迁移能像写rails那么爽就好了….</li>
<li>跨线程传递数据还算麻烦,不过可以接受.</li>
<li>realm对象如果调用<code>class</code>方法会返回类似于<code>RLMAccessor_2_Day</code>的结果,而不是预想的<code>Day</code>,这点注意一下就好.</li>
<li><code>Realm</code>是<code>C++</code>实现的,所以看着一堆<code>.mm</code>的源码,对我来说基本不会产生去阅读.的想法</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/04/15/iOS9新特性の3D-touch-下篇/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄少华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="crossPQW">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/04/15/iOS9新特性の3D-touch-下篇/" itemprop="url">iOS9新特性の3D-touch-下篇</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-04-15T16:43:34+08:00">
                2016-04-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/04/15/iOS9新特性の3D-touch-下篇/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/04/15/iOS9新特性の3D-touch-下篇/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>再看一下如何在应用内集成3Dtouch.<br>3D-touch操作分为轻按<code>peek</code>跟重按<code>pop</code>,根据apple官方设计规范,一般来说<code>peek</code>呼出预览视图,我在storyboard里面创建一个<code>PreviewController</code>用于描述呼出的预览视图,同时创建了一个<code>DetailViewController</code>用于显示最终显示的视图,同时我们应该注意,<code>pop</code>之后的视图应该与用户正常点击进去之后没有任何区别.<br>此时我们应用层级为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tableView---(peek)----&gt;previewController---(pop)---&gt;DetailviewController</span><br></pre></td></tr></table></figure></p>
<p>无论何时,我们在使用3D-touch的时候应当先检查3D-touch的可用性<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (void)check3Dtouch</span><br><span class="line">&#123;</span><br><span class="line">    //检测3Dtouch是否可用,若可用注册预览视图代理</span><br><span class="line">    if (self.traitCollection.forceTouchCapability == UIForceTouchCapabilityAvailable) &#123;</span><br><span class="line">        [self registerForPreviewingWithDelegate:self sourceView:self.view];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>我们在viewWillAppear里面和用户进行3D-touch相关设置的时候都要检查可用性<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewWillAppear:(BOOL)animated</span><br><span class="line">&#123;</span><br><span class="line">    [super viewWillAppear:animated];</span><br><span class="line">    </span><br><span class="line">    [self check3Dtouch];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">///用户可能进入设置开启/关闭3Dtouch的时候,在这里需要再次检测3Dtouch可用性</span><br><span class="line">- (void)traitCollectionDidChange:(UITraitCollection *)previousTraitCollection</span><br><span class="line">&#123;</span><br><span class="line">    [self check3Dtouch];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>别忘了设置<code>UIViewControllerPreviewingDelegate</code>预览视图代理.</p>
<p>接下来只需要在对应的代理方法里面返回相应的控制器即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (UIViewController *)previewingContext:(id&lt;UIViewControllerPreviewing&gt;)previewingContext viewControllerForLocation:(CGPoint)location&#123;</span><br><span class="line">    </span><br><span class="line">    if ([self.presentedViewController isKindOfClass:[PreviewViewController class]]) &#123;return nil;&#125;</span><br><span class="line">    </span><br><span class="line">    UIStoryboard *sb = [UIStoryboard storyboardWithName:@&quot;Main&quot; bundle:nil];</span><br><span class="line">    PreviewViewController *previewController = [sb instantiateViewControllerWithIdentifier:@&quot;preview&quot;];</span><br><span class="line">    </span><br><span class="line">    location = CGPointMake(10, 100);</span><br><span class="line">    return previewController;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)previewingContext:(id&lt;UIViewControllerPreviewing&gt;)previewingContext commitViewController:(UIViewController *)viewControllerToCommit&#123;</span><br><span class="line">    </span><br><span class="line">    UIStoryboard *sb = [UIStoryboard storyboardWithName:@&quot;Main&quot; bundle:nil];</span><br><span class="line">    DetailViewController *detailView = [sb instantiateViewControllerWithIdentifier:@&quot;detailView&quot;];</span><br><span class="line">    </span><br><span class="line">    [self showViewController:detailView sender:self];</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>此时<code>peek</code>跟<code>pop</code>手势都已经集成完毕,这时候还想实现类似在preview下面添加alert的操作,如系统message里面的快捷回复</p>
<p><img src="http://upload-images.jianshu.io/upload_images/290760-7bc6dc52f175f6af.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="8.png"><br>其实只需要在previewController里面实现<code>- (NSArray&lt;id&lt;UIPreviewActionItem&gt;&gt; *)previewActionItems</code>方法即可.<br><em>PS:在xcode6.3时OC添加了制定数组元组类型的功能,有利于写出更加严谨的代码,好评~</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- (NSArray&lt;id&lt;UIPreviewActionItem&gt;&gt; *)previewActionItems</span><br><span class="line">&#123;</span><br><span class="line">    UIPreviewAction *action1 = [UIPreviewAction actionWithTitle:@&quot;action1&quot; style:UIPreviewActionStyleDefault handler:^(UIPreviewAction * _Nonnull action, UIViewController * _Nonnull previewViewController) &#123;</span><br><span class="line">        NSLog(@&quot;action1 click&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">    UIPreviewAction *action2 = [UIPreviewAction actionWithTitle:@&quot;action2&quot; style:UIPreviewActionStyleDestructive handler:^(UIPreviewAction * _Nonnull action, UIViewController * _Nonnull previewViewController) &#123;</span><br><span class="line">        NSLog(@&quot;action2 click&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">    UIPreviewAction *action3 = [UIPreviewAction actionWithTitle:@&quot;action3&quot; style:UIPreviewActionStyleSelected handler:^(UIPreviewAction * _Nonnull action, UIViewController * _Nonnull previewViewController) &#123;</span><br><span class="line">        NSLog(@&quot;action3 click&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    UIPreviewActionGroup *group1 = [UIPreviewActionGroup actionGroupWithTitle:@&quot;group1&quot; style:UIPreviewActionStyleDefault actions:@[action1,action2]];</span><br><span class="line">    UIPreviewActionGroup *group2 = [UIPreviewActionGroup actionGroupWithTitle:@&quot;group2&quot; style:UIPreviewActionStyleDestructive actions:@[action1,action3]];</span><br><span class="line">    UIPreviewActionGroup *group3 = [UIPreviewActionGroup actionGroupWithTitle:@&quot;group3&quot; style:UIPreviewActionStyleSelected actions:@[action2,action3]];</span><br><span class="line">    </span><br><span class="line">//    NSArray *items = @[action1,action2,action3];</span><br><span class="line">//    NSArray *items = @[group1,group2,group3];</span><br><span class="line">    NSArray *items = @[action1,group1,action2,group2,action3,group3];</span><br><span class="line">    return items;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有兴趣的话可以自己动手体会一下<code>UIPreviewActionGroup</code>与<code>UIPreviewAction</code>的区别.</p>
<p><a href="https://github.com/crossPQW/3d-touch-demo" target="_blank" rel="noopener">你可以在github下载到此源码</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/04/15/iOS9新特性の3D-touch-上篇/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄少华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="crossPQW">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/04/15/iOS9新特性の3D-touch-上篇/" itemprop="url">iOS9新特性の3D-touch-上篇</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-04-15T15:34:35+08:00">
                2016-04-15
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/04/15/iOS9新特性の3D-touch-上篇/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/04/15/iOS9新特性の3D-touch-上篇/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>iPhone6s&amp;iPhone 6s plus发布也有一段时间了,最大的亮点应该就是3D-touch毋庸置疑了,第一时间体验了之后最大的感受就是苹果爸爸太给力了…….事实上我也从未见过第二家公司能把科技与易用性结合的如此天衣无缝的,当年5s指纹识别如此,今年的3D-touch亦如此.苹果也开放了相关的api,作为一个开发者怎能不第一时间在自己的应用上面集成这个好玩的特性呢.</p>
</blockquote>
<p>应用中使用3Dtouch有两种方式:  </p>
<ul>
<li>第一种是按压图标启动应用的时候,类似于pc上面的右键,但是又不同于右键,我们可以把它理解为一个快速入口,能够有效的减少用户的操作量.这里我们只能使用轻按手势<code>shortCut</code>.  </li>
<li>第二种则是应用内的集成了,比如短信列表我们可以轻按预览短信内容,发现感兴趣的话再稍微用力进入详情页面,事实上目前大多数集成了3Dtouch的app也大多数是应用在这个使用场景,即在list-detail之间加了一层预览,变成了list-preview-detail.</li>
</ul>
<p>上篇先写一下第一种场景如何集成.<br>这时候我们的所有代码都是在app delegate里面完成的,当然我们也可以写一个分类方便给app delegate瘦身.</p>
<h6 id="在app-delegate的代理方法didFinishLaunchingWithOptions里面做如下操作"><a href="#在app-delegate的代理方法didFinishLaunchingWithOptions里面做如下操作" class="headerlink" title="在app delegate的代理方法didFinishLaunchingWithOptions里面做如下操作:"></a>在app delegate的代理方法didFinishLaunchingWithOptions里面做如下操作:</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions &#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    ///setup icons</span><br><span class="line">    UIApplicationShortcutIcon *icon1 = [UIApplicationShortcutIcon iconWithType:UIApplicationShortcutIconTypeCompose];</span><br><span class="line">    UIApplicationShortcutIcon *icon2 = [UIApplicationShortcutIcon iconWithType:UIApplicationShortcutIconTypeLocation];</span><br><span class="line">    UIApplicationShortcutIcon *icon3 = [UIApplicationShortcutIcon iconWithType:UIApplicationShortcutIconTypePause];</span><br><span class="line">    UIApplicationShortcutIcon *icon4 = [UIApplicationShortcutIcon iconWithTemplateImageName:@&quot;favicon.png&quot;];</span><br><span class="line">    </span><br><span class="line">    ///setup items</span><br><span class="line">    UIMutableApplicationShortcutItem *item1 = [[UIMutableApplicationShortcutItem alloc] initWithType:@&quot;first&quot; localizedTitle:@&quot;first item title&quot; localizedSubtitle:@&quot;first item detail title&quot; icon:icon1 userInfo:nil];</span><br><span class="line">    UIMutableApplicationShortcutItem *item2 = [[UIMutableApplicationShortcutItem alloc] initWithType:@&quot;second&quot; localizedTitle:@&quot;second item title&quot; localizedSubtitle:@&quot;second item detail title&quot; icon:icon2 userInfo:nil];</span><br><span class="line">    UIMutableApplicationShortcutItem *item3 = [[UIMutableApplicationShortcutItem alloc] initWithType:@&quot;third&quot; localizedTitle:@&quot;third item title&quot; localizedSubtitle:@&quot;third item detail title&quot; icon:icon3 userInfo:nil];</span><br><span class="line">    UIMutableApplicationShortcutItem *item4 = [[UIMutableApplicationShortcutItem alloc] initWithType:@&quot;forth&quot; localizedTitle:@&quot;forth item title&quot; localizedSubtitle:@&quot;forth item detail title&quot; icon:icon4 userInfo:nil];</span><br><span class="line">    </span><br><span class="line">    NSArray *items = @[item1,item2,item3,item4];</span><br><span class="line">    </span><br><span class="line">    [UIApplication sharedApplication].shortcutItems = items ;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    UIApplicationShortcutItem *item = [launchOptions valueForKey:UIApplicationLaunchOptionsShortcutItemKey];</span><br><span class="line">    if (item) &#123;</span><br><span class="line">        NSLog(@&quot;3d launch item is %@&quot;,item.localizedTitle);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        NSLog(@&quot;normal launch&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return YES;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码还是非常简单的,就是创建四个图标,然后创建四个item,然后给shortcutItems赋值一个数组就可以了.<br>需要注意的是,使用了<code>iconWithTemplateImageName</code>方法创建的自定义的图标需要是正方形,单色,而且35*35point尺寸的,不然会显示下面效果图那种黑漆漆的效果.</p>
<blockquote>
<p>Icons should be square, single color, and 35x35 points  </p>
</blockquote>
<p>而我们如果想监听是从哪个item启动的应用,可以在以下方法里面操作:</p>
<pre><code>- (void)application:(UIApplication *)application performActionForShortcutItem:(UIApplicationShortcutItem *)shortcutItem completionHandler:(void (^)(BOOL))completionHandler
{
    NSLog(@&quot;selected item&apos;s title is %@&quot;,shortcutItem.description);
}
</code></pre><p>可以看到打印信息:</p>
<p><img src="http://upload-images.jianshu.io/upload_images/290760-f9e486885307b47e.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="6.jpg"><br>所以这里我们就可以通过shortcutItem.type来判断从哪个入口进入的了,所以我们在调用<code>- (instancetype _Nonnull)initWithType:(NSString * _Nonnull)type localizedTitle:(NSString * _Nonnull)localizedTitle localizedSubtitle:(NSString * _Nullable)localizedSubtitle icon:(UIApplicationShortcutIcon * _Nullable)icon userInfo:(NSDictionary * _Nullable)userInfo</code>初始化item的时候,可以自定义一个枚举来作为type参数,方便以后判断. </p>
<p>最终效果如下:  </p>
<p><img src="http://upload-images.jianshu.io/upload_images/290760-219f269a051fe040.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="7.jpg"><br><a href="https://github.com/crossPQW/3d-touch-demo" target="_blank" rel="noopener">你可以在这里下载这个demo</a></p>
<p><del>一个问题:<br>微信实现的图标居右是如何实现的呢?因为没有找到相关的api,难道是通过runtime来修改title跟icon的frame来做到的?</del><br>好傻逼的问题,突然发现图片左右是取决于图标在屏幕上的问题……..草草草草草</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/04/07/使用CAAnimation打造一个有意思的loading动画/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄少华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="crossPQW">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/04/07/使用CAAnimation打造一个有意思的loading动画/" itemprop="url">使用CAAnimation打造一个有意思的loading动画</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-04-07T16:39:40+08:00">
                2016-04-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/04/07/使用CAAnimation打造一个有意思的loading动画/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/04/07/使用CAAnimation打造一个有意思的loading动画/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>项目中遇到一个比较有意思的loading动画需求,最终效果如下: </p>
<p><img src="http://upload-images.jianshu.io/upload_images/290760-11f05afbb5ee073e.gif?imageMogr2/auto-orient/strip" alt="screenShot.gif"></p>
<h6 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h6><p>相信很多人跟我一样第一眼被这张图欺骗了,以为是有一个实心圆在做缩放旋转的动画,其实仔细单独观察每个圆形,不难看出,这个loading只是由8个圆形规律的做放大缩小的动画,同时加上了透明度的变化达到了图中的效果,由此我们有了思路:8个圆形,scale animate + opacity animate.</p>
<h6 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h6><p>我尝试使用最基础的<code>CAAnimation</code>中api来完成想要的效果,由之前的思路,我们首先将缩放动画与透明渐变动画实现出来:  </p>
<ol>
<li><strong>缩放</strong>.我们可以看出每个圆形的缩放比例是经历了 <code>1,0.4,1</code>这三个阶段,当然你也可以理解为<code>0.4,1,0.4</code>,至于为什么是0.4,仅仅是觉的比较好看Orz,并且我们定义动画完成一个循环需要的时间是1s. </li>
<li><strong>透明渐变</strong>. 每个圆形的opacity属性经历了<code>1,0.3,1</code>这三个阶段,同上选中<code>0.3,1,0.3</code>也取决于你的喜好,同样的一个循环时间为1s. </li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">//scale</span><br><span class="line">- (CAKeyframeAnimation *)scaleAnimation &#123;</span><br><span class="line">    CAKeyframeAnimation *scaleAnimate = [CAKeyframeAnimation animationWithKeyPath:@&quot;transform.scale&quot;];</span><br><span class="line">    scaleAnimate.keyTimes = @[@0, @0.5, @1];</span><br><span class="line">    scaleAnimate.values = @[@1, @0.4, @1];</span><br><span class="line">    scaleAnimate.duration = kDuration;</span><br><span class="line">    return scaleAnimate;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//opactity</span><br><span class="line">- (CAKeyframeAnimation *)opactityAnimation &#123;</span><br><span class="line">    CAKeyframeAnimation *opacityAnimaton = [CAKeyframeAnimation animationWithKeyPath:@&quot;opacity&quot;];</span><br><span class="line">    opacityAnimaton.keyTimes = @[@0, @0.5, @1];</span><br><span class="line">    opacityAnimaton.values = @[@1, @0.3, @1];</span><br><span class="line">    opacityAnimaton.duration = kDuration;</span><br><span class="line">    return opacityAnimaton;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">```  </span><br><span class="line">接下来我们使用`CAAnimationGroup`来包装这两个动画:</span><br></pre></td></tr></table></figure>
<p>CAAnimationGroup *animation = [[CAAnimationGroup alloc] init];<br>    animation.animations = @[[self scaleAnimation], [self opactityAnimation]];<br>    animation.timingFunction = [CAMediaTimingFunction functionWithName:kCAMediaTimingFunctionLinear];<br>    animation.duration = 1.f;<br>    animation.repeatCount = HUGE;<br>    animation.removedOnCompletion = NO;</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">最后的步骤,按照圆形排列绘制8个原点,我们可以使用`CAShapeLayer`跟`UIBszierPath`结合来绘制圆形图案,代码都非常简单,不做更多解读了,至于8个图形的摆放位置这里可能需要一点高中数学知识了:</span><br></pre></td></tr></table></figure>
<pre><code>for (int i = 0; i &lt; 8; i++) {
    CALayer *circle = [self circleLayerWithAngle:M_PI_4 * i size:circleSize origin:CGPointMake(x, y) containerSize:size color:tintColor];

    animation.beginTime = beginTime + i * 0.12;
    [circle addAnimation:animation forKey:@&quot;animation&quot;];
    [layer addSublayer:circle];
}  
</code></pre><ul>
<li><p>(CALayer <em>)circleLayerWithAngle:(CGFloat)angle size:(CGFloat)size origin:(CGPoint)origin containerSize:(CGSize)containerSize  color:(UIColor </em>)color{<br>  CGFloat raduis = containerSize.width * 0.5;</p>
<p>  CAShapeLayer <em>layer = [CAShapeLayer layer];<br>  UIBezierPath </em>path = [[UIBezierPath alloc] init];</p>
<p>  [path addArcWithCenter:CGPointMake(size <em> 0.5, size </em> 0.5) radius:size <em> 0.5 startAngle:0 endAngle:M_PI </em> 2 clockwise:NO];<br>  [path closePath];<br>  layer.fillColor = color.CGColor;<br>  layer.path = path.CGPath;</p>
<p>  CGRect frame = CGRectMake(origin.x + raduis * (cos(angle) + 1),</p>
<pre><code>origin.y + raduis * (sin(angle) + 1),
size, size);
</code></pre><p>  layer.frame = frame;<br>  return layer;<br>}</p>
</li>
</ul>
<p>```<br>通常,对于这种小的动画我习惯封装成一个单独的animation类,方便在其他地方调用,你可以在<a href="https://github.com/crossPQW/loading" target="_blank" rel="noopener">这里</a>下载到这个demo.<br>如有你对本文有什么好的建议,欢迎提出咯</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/03/16/iOS圆角那些事/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄少华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="crossPQW">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/16/iOS圆角那些事/" itemprop="url">iOS圆角那些事</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-03-16T15:34:35+08:00">
                2016-03-16
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/03/16/iOS圆角那些事/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/03/16/iOS圆角那些事/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>似乎没有那家公司比Apple更爱圆角了,事实上,圆角也会让图形/产品看起来更加无侵略性,能够带来更好的用户体验.<br>iOS开发中各种圆角也随处可见,最简单给控件添加圆角的方式就是给视图的layer设置corner属性了:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">self.blueView.layer.cornerRadius = 5.f;</span><br><span class="line">self.blueView.layer.masksToBounds = YES;</span><br></pre></td></tr></table></figure></p>
<p>这种方式会带来两个问题:  </p>
<ul>
<li><ol>
<li>当图片数量比较多的时候,这种添加圆角方式特别消耗性能,比如在<code>UITableViewCell</code>添加过多圆角的话,甚至会带来视觉可见的卡顿.  </li>
</ol>
</li>
<li><ol>
<li>无法配置圆角数量(只能添加view的四个角全为圆角),无法配置某个圆角大小.   </li>
</ol>
</li>
</ul>
<p>第一个问题实际上是由于数量太多的情况下,系统会频繁的调用GPU的离屏渲染(Offscreen Rendering)机制,导致内存损耗严重.更多关于离屏渲染的详解,可以看<a href="http://objccn.io/issue-3-1/" target="_blank" rel="noopener">这里</a>,本文不多赘述.</p>
<p>第二个问题,我们可以使用<code>UIBezierPath</code>来完美解决.以下是示例代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">UIBezierPath *maskPath = [UIBezierPath bezierPathWithRoundedRect:self.blueView.bounds byRoundingCorners:UIRectCornerTopLeft | UIRectCornerBottomLeft cornerRadii:CGSizeMake(20, 0)];</span><br><span class="line"></span><br><span class="line">CAShapeLayer *maskLayer = [[CAShapeLayer alloc] init];</span><br><span class="line">   </span><br><span class="line">maskLayer.frame = self.blueView.bounds;</span><br><span class="line"></span><br><span class="line">maskLayer.path = maskPath.CGPath;</span><br><span class="line"></span><br><span class="line">self.blueView.layer.mask = maskLayer;</span><br><span class="line"></span><br><span class="line">self.blueView.layer.cornerRadius = 5.f;</span><br><span class="line">self.blueView.layer.masksToBounds = YES;</span><br></pre></td></tr></table></figure></p>
<p>想要配置某个角为圆角的话,只需要指定对应的<code>UIRectCorner</code>即可</p>
<p><img src="http://upload-images.jianshu.io/upload_images/290760-bf139e23eb1e8ad4.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="5.jpg"> </p>
<p>以下是显示效果:</p>
<p><img src="http://upload-images.jianshu.io/upload_images/290760-b118ec762f3d9188.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="4.jpg"><br>你可以在这些下载这个<a href="https://github.com/crossPQW/iOS-corner" target="_blank" rel="noopener">demo</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/03/08/简明的集成touchID教程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄少华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="crossPQW">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/03/08/简明的集成touchID教程/" itemprop="url">简明的集成touchID教程</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-03-08T15:54:45+08:00">
                2016-03-08
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/03/08/简明的集成touchID教程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/03/08/简明的集成touchID教程/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>iOS指纹验证API的开放给了我们应用更多的可能性,touchID的API使用起来也特别的简单,接下来我做了一个小demo来集成了touchID,直接把步骤贴出来.</p>
<p>导入指纹识别的framework,在你的工程中导入<code>LocalAuthentication.framework</code>,并引入头文件.<code>#import &lt;LocalAuthentication/LocalAuthentication.h&gt;</code></p>
<p>首先需要获取到LocalAuthentication上下文:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//使用之前,需要先获取上下文.</span><br><span class="line">    LAContext *context = [[LAContext alloc] init];</span><br></pre></td></tr></table></figure></p>
<p>然后必须要先检查指纹识别是否可用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NSError *error;</span><br><span class="line">if (![context canEvaluatePolicy:LAPolicyDeviceOwnerAuthenticationWithBiometrics error:&amp;error]) &#123;</span><br><span class="line">    NSLog(@&quot;error:%@&quot;,error.localizedDescription);</span><br><span class="line"></span><br><span class="line">    return;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>调取touchID的API:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[context evaluatePolicy:LAPolicyDeviceOwnerAuthenticationWithBiometrics localizedReason:@&quot;请验证您的指纹&quot; reply:^(BOOL success, NSError *authenticationError) &#123;</span><br><span class="line">       </span><br><span class="line">      dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">          </span><br><span class="line">          if (success) &#123;</span><br><span class="line">              NSLog(@&quot;success&quot;);</span><br><span class="line">          &#125;else&#123;</span><br><span class="line">              NSLog(@&quot;error == :%@&quot;,authenticationError);</span><br><span class="line">          &#125;</span><br><span class="line">       </span><br><span class="line">          </span><br><span class="line">      &#125;) ;</span><br><span class="line">   &#125;];</span><br></pre></td></tr></table></figure></p>
<p>最终效果</p>
<p><img src="http://upload-images.jianshu.io/upload_images/290760-c9abd93525ccb4c2.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="3.jpg"><br><a href="https://github.com/crossPQW/UIAlertController/tree/master" target="_blank" rel="noopener">demo地址</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/01/16/git问题记录--如何从从detached HEAD状态解救出来/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄少华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="crossPQW">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/01/16/git问题记录--如何从从detached HEAD状态解救出来/" itemprop="url">git问题记录--如何从从detached HEAD状态解救出来</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-01-16T17:23:34+08:00">
                2016-01-16
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/01/16/git问题记录--如何从从detached HEAD状态解救出来/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/01/16/git问题记录--如何从从detached HEAD状态解救出来/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天使用git的时候在终端发现这样一条信息<br><code>HEAD detached at head</code></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a><strong>分析</strong></h2><p>心里一惊,艾玛这是什么状态?<br>其实我们知道,<code>git checkout</code>本质上是修改HEAD里面的内容来让它指向不同分支的,而HEAD文件指向的分支就是我们当前的分支,但是有时候HEAD不会指向任何分支,严谨的说是HEAD指向了一个没有分支名字的修订版本,此时恭喜你,已经处于游离状态了(detached HEAD).这时候我们在进行commit操作不会提交到任何分支上去.  </p>
<p>这个时候输入<code>git status</code>查看当前状态发现我没有在任何本地分支上也验证了刚才的猜想,而这时候我又作死的进行了commit操作,git提示我</p>
<pre><code>Warning: you are leaving 1 commit behind, not connected to
any of your branches:

  fef4501 interrationRecord page completed

If you want to keep them by creating a new branch, this may be a good time
to do so with:

 git branch &lt;new-branch-name&gt; fef4501
</code></pre><p>然后我欢天喜地的<code>git checkout ask_11_16</code>切换到工作分支以为万事大吉,艾玛坑爹啊,我特么辛辛苦苦写了一天的代码呢?不过这时候我们回看上面那段提示,智能的git告诉我如果我还想要这次提交的话,可以创建一个新的分支,同时把本次提交的id告诉了我:<code>fef4501</code>.<br>那么这时候我已经有了一个思路:</p>
<ol>
<li>基于本次提交创建一个临时分支.</li>
<li>然后merge到我当前工作分支.</li>
<li>删除临时分支  </li>
</ol>
<h2 id="实操"><a href="#实操" class="headerlink" title="实操"></a><strong>实操</strong></h2><h4 id="基于本次提交创建临时分支"><a href="#基于本次提交创建临时分支" class="headerlink" title="基于本次提交创建临时分支"></a>基于本次提交创建临时分支</h4><p>输入<br><code>$git branch temp fef4501</code><br>使用git branch 分支名 操作ID 这句命令能够创建一个新的分支,但要注意此时我们还没有切换到这个分支上,这个分支上面代码跟我刚才提交完之后的一样.</p>
<h4 id="切换到工作分支并合并代码"><a href="#切换到工作分支并合并代码" class="headerlink" title="切换到工作分支并合并代码"></a>切换到工作分支并合并代码</h4><p>输入<br><code>$git checkout ask_11_16</code><br>意味着我已经切换到ask_11_16分支,这个分支是我之前想要提交的分支.<br>然后<br><code>$git merge temp</code><br>这行命令过后我们已经上次commit合并到ask_11_16上了,此时终端状态为<br><code>Your branch is ahead of &#39;origin/ask_11_16&#39; by 1 commit.</code><br>我们只需要<code>$git push</code>即可把本次提交push到远程分支.<br>这时候检查代码,perfect!正式我们想要的状态.</p>
<h4 id="删除temp分支"><a href="#删除temp分支" class="headerlink" title="删除temp分支"></a>删除temp分支</h4><p>大功告成,至于temp分支已经没有了利用价值,本着过河拆桥的精神我不得不输入<br><code>$git branch -d temp</code><br>来删除temp分支. </p>
<p><em>git是一个很优秀的版本控制工具,利用得当能让我们在团队协作时候如鱼得水,但是万一有操作失误,也会让很多不熟悉git命令的人各种发愁,下面贴一个git命令大全,非常实用</em></p>
<p><img src="http://upload-images.jianshu.io/upload_images/290760-e8491f69473bf200.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="9.jpg"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/01/09/给项目中所有xib添加圆角:borderColor等属性/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄少华">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="crossPQW">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2016/01/09/给项目中所有xib添加圆角:borderColor等属性/" itemprop="url">给项目中所有xib添加圆角/borderColor等属性</a></h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-01-09T11:52:46+08:00">
                2016-01-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/01/09/给项目中所有xib添加圆角:borderColor等属性/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/01/09/给项目中所有xib添加圆角:borderColor等属性/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>废话不多,先上<a href="https://github.com/crossPQW/addCornerRadiusForAllXib" target="_blank" rel="noopener">github地址</a>,不想看啰嗦的话,直接把项目中<code>UIView+CornerRadius</code>分类导入到自己项目中即可,不需要其他任何操作.    </p>
</blockquote>
<p>使用xib+storyboard开发能够极大的提高开发效率发展到现在这点应该没有什么异议了,如果还有禁止使用这些东西的公司我觉的可以考虑辞职了……<br>但是有一些属性再系统默认的设置面板里面我们并不能找到,最常用的就是<code>layer.borderWidth,layer.cornerRadius,layer.borderColor</code>这三个属性了,之前都是手动在runtime属性里面手动添加,比如: </p>
<p><img src="http://upload-images.jianshu.io/upload_images/290760-668e169e3a2b8ec8.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="16.jpg"><br>但是每次用都要加上去未免太过麻烦,于是就在想能不能有个好的方式代替这种繁琐的操作,后来发现现在oc有了新的关键字就是来做这个事情的:<code>IBInspectable</code></p>
<h6 id="基础版"><a href="#基础版" class="headerlink" title="基础版"></a>基础版</h6><p>在给你用的那个xib添加对应属性,加上<code>IBInspectable</code>关键字,比如:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic, assign)IBInspectable CGFloat cornerRadius;</span><br></pre></td></tr></table></figure></p>
<p>这样我们就能在面板里面直接控制圆角大小了,与此同时我们还可以加上<code>IB_DESIGNABLE</code>关键字,来让xib可以可视化的设置属性,所见即所得.</p>
<p>似乎达到了要求,但是开头那个痛点还在:每个xib都要去设置.</p>
<p>于是乎我又想到了通过给<code>UIView</code>添加一个分类来做这件事情,就有了下面的过程: </p>
<h6 id="进阶版"><a href="#进阶版" class="headerlink" title="进阶版"></a>进阶版</h6><p>新建一个<code>UIView+CornerRadius</code>的分类,在分类的头文件中添加平时用到的一些属性,别忘了<code>IBInspectable</code>关键字<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic, assign)IBInspectable CGFloat cornerRadius;</span><br><span class="line">@property (nonatomic, assign)IBInspectable CGFloat borderWidth;</span><br><span class="line">@property (nonatomic, strong)IBInspectable UIColor *borderColor;</span><br></pre></td></tr></table></figure></p>
<p>由于OC的特性,分类是无法扩展属性的,所以这里我们需要手动实现其set方法与get方法:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (CGFloat)cornerRadius</span><br><span class="line">&#123;</span><br><span class="line">    return [objc_getAssociatedObject(self, @selector(cornerRadius)) floatValue];</span><br><span class="line">&#125;</span><br><span class="line">- (void)setCornerRadius:(CGFloat)cornerRadius</span><br><span class="line">&#123;</span><br><span class="line">    self.layer.cornerRadius = cornerRadius;</span><br><span class="line">    self.layer.masksToBounds = YES;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (CGFloat)borderWidth</span><br><span class="line">&#123;</span><br><span class="line">    return [objc_getAssociatedObject(self, @selector(borderWidth)) floatValue];</span><br><span class="line">&#125;</span><br><span class="line">- (void)setBorderWidth:(CGFloat)borderWidth</span><br><span class="line">&#123;</span><br><span class="line">    self.layer.borderWidth = borderWidth;</span><br><span class="line">    self.layer.masksToBounds = YES;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (UIColor *)borderColor</span><br><span class="line">&#123;</span><br><span class="line">    return objc_getAssociatedObject(self, @selector(borderColor));</span><br><span class="line">&#125;</span><br><span class="line">- (void)setBorderColor:(UIColor *)borderColor</span><br><span class="line">&#123;</span><br><span class="line">    self.layer.borderColor = borderColor.CGColor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>大功告成,到这里为止,我们在xib中使用<code>UIView</code>的子类的时候,都可以很方便的设置<code>borderColor , borderWidth, cornerRadius</code>了,如果有兴趣,还可以扩展更多的属性.<br>如图:</p>
<p><img src="http://upload-images.jianshu.io/upload_images/290760-09a4b89000788d56.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="17.jpg"></p>
<h5 id="美中不足"><a href="#美中不足" class="headerlink" title="美中不足"></a>美中不足</h5><p>使用了分类的话,是无法通过<code>IB_DESIGNABLE</code>进行实时修改实时显示的,所以只有在运行后能看到实际效果,个人猜测是使用了分类之后并不能给原类扩展属性,仅仅是添加了相应的set与get方法导致的,如果有人知道能够解决这个问题,求告知啊~~~</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">黄少华</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            

          </nav>

          

          <div class="links-of-author motion-element">
            
          </div>

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2014 &mdash; <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">黄少华</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.3</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.3"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.3"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.3"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.3"></script>



  


  

    
      <script id="dsq-count-scr" src="https://crossPQW.disqus.com/count.js" async></script>
    

    

  




	





  










  





  

  

  

  

  

  

</body>
</html>
