<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>读码笔记-YYWebImage源码 (二) -YYWebImageOperation.md | crossPQW</title>
  <meta name="viewport" content="width=device-width">
  <meta name="description" content="不得不说,YYKit系列的横空出世让很多人对国内的开发者都摘下了有色眼镜,原来并非大神全是国外的,自己膜拜之余也想读一下具体的一些实现细节,所以到github上fork了YYWebImage阅读源码并把注释写在response里面,权当笔记.  第一天,YYWebImageManager类头文件123456789101112131415161718192021222324252627282930">
<meta property="og:type" content="article">
<meta property="og:title" content="读码笔记-YYWebImage源码 (二) -YYWebImageOperation.md">
<meta property="og:url" content="http://yoursite.com/2015/12/14/读码笔记-YYWebImage源码 (一) - YYWebImageManager/index.html">
<meta property="og:site_name" content="crossPQW">
<meta property="og:description" content="不得不说,YYKit系列的横空出世让很多人对国内的开发者都摘下了有色眼镜,原来并非大神全是国外的,自己膜拜之余也想读一下具体的一些实现细节,所以到github上fork了YYWebImage阅读源码并把注释写在response里面,权当笔记.  第一天,YYWebImageManager类头文件123456789101112131415161718192021222324252627282930">
<meta property="og:image" content="http://yoursite.com/content/images/2015/12/8FDD6A84-B469-4A4D-8B9C-6DAE86547031.png">
<meta property="og:updated_time" content="2017-12-14T15:01:50.819Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="读码笔记-YYWebImage源码 (二) -YYWebImageOperation.md">
<meta name="twitter:description" content="不得不说,YYKit系列的横空出世让很多人对国内的开发者都摘下了有色眼镜,原来并非大神全是国外的,自己膜拜之余也想读一下具体的一些实现细节,所以到github上fork了YYWebImage阅读源码并把注释写在response里面,权当笔记.  第一天,YYWebImageManager类头文件123456789101112131415161718192021222324252627282930">
<meta name="twitter:image" content="http://yoursite.com/content/images/2015/12/8FDD6A84-B469-4A4D-8B9C-6DAE86547031.png">
  
    <link rel="alternative" href="/atom.xml" title="crossPQW" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>
<body>
  <div id="container">
    <div class="mobile-nav-panel">
	<i class="icon-reorder icon-large"></i>
</div>
<header id="header">
	<h1 class="blog-title">
		<a href="/">crossPQW</a>
	</h1>
	<nav class="nav">
		<ul>
			<li><a href="/">Home</a></li><li><a href="/archives">Archives</a></li>
			<li><a id="nav-search-btn" class="nav-icon" title="Search"></a></li>
			<li><a href="/atom.xml" id="nav-rss-link" class="nav-icon" title="RSS Feed"></a></li>
		</ul>
	</nav>
	<div id="search-form-wrap">
		<form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
	</div>
</header>
    <div id="main">
      <article id="post-读码笔记-YYWebImage源码 (一) - YYWebImageManager" class="post">
	<footer class="entry-meta-header">
		<span class="meta-elements date">
			<a href="/2015/12/14/读码笔记-YYWebImage源码 (一) - YYWebImageManager/" class="article-date">
  <time datetime="2015-12-14T08:15:59.000Z" itemprop="datePublished">2015-12-14</time>
</a>
		</span>
		<span class="meta-elements author">黄少华</span>
		<div class="commentscount">
			
		</div>
	</footer>
	
	<header class="entry-header">
		
  
    <h1 class="article-title entry-title" itemprop="name">
      读码笔记-YYWebImage源码 (二) -YYWebImageOperation.md
    </h1>
  

	</header>
	<div class="entry-content">
		
    	<blockquote>
<p>不得不说,YYKit系列的横空出世让很多人对国内的开发者都摘下了有色眼镜,原来并非大神全是国外的,自己膜拜之余也想读一下具体的一些实现细节,所以到github上fork了<code>YYWebImage</code>阅读源码并把注释写在response里面,权当笔记.</p>
</blockquote>
<p>第一天,<strong><code>YYWebImageManager</code></strong>类<br>头文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;UIKit/UIKit.h&gt;</span><br><span class="line"></span><br><span class="line">#if __has_include(&lt;YYWebImage/YYWebImage.h&gt;)</span><br><span class="line">#import &lt;YYWebImage/YYImageCache.h&gt;</span><br><span class="line">#else</span><br><span class="line">#import &quot;YYImageCache.h&quot;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">@class YYWebImageOperation;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/// The options to control image operation.</span><br><span class="line">///控制图片请求的模式</span><br><span class="line">typedef NS_OPTIONS(NSUInteger, YYWebImageOptions) &#123;</span><br><span class="line">    </span><br><span class="line">    /// Show network activity on status bar when download image.</span><br><span class="line">    ///当下载图片的时候会在状态栏显示一个当前网络状况</span><br><span class="line">    YYWebImageOptionShowNetworkActivity = 1 &lt;&lt; 0,</span><br><span class="line">    </span><br><span class="line">    /// Display progressive/interlaced/baseline image during download (same as web browser).</span><br><span class="line">    ///能够像浏览器一样显示一个逐渐显示的图片,有三种方式:换换显示,中间带交叉效果,基于基线显示.这里可以看demo理解三种模式的区别</span><br><span class="line">    YYWebImageOptionProgressive = 1 &lt;&lt; 1,</span><br><span class="line">    </span><br><span class="line">    /// Display blurred progressive JPEG or interlaced PNG image during download.</span><br><span class="line">    /// This will ignore baseline image for better user experience.</span><br><span class="line">    ///下载的时候显示一个模糊的渐渐显示的JPEG图片,或者一个交错显示的PNG图片,具体效果还是看demo</span><br><span class="line">    ///这种模式会忽略baseline这种显示模式来获得更好的用户体验</span><br><span class="line">    YYWebImageOptionProgressiveBlur = 1 &lt;&lt; 2,</span><br><span class="line">    </span><br><span class="line">    /// Use NSURLCache instead of YYImageCache.</span><br><span class="line">    ///使用NSURLCache来代替YYImageCache</span><br><span class="line">    YYWebImageOptionUseNSURLCache = 1 &lt;&lt; 3,</span><br><span class="line">    </span><br><span class="line">    /// Allows untrusted SSL ceriticates.</span><br><span class="line">    ///允许未受信任的SSL证书,PS:基于我的理解以及对比SDWebImage,这种模式一般用户调试过程,不用于生产过程</span><br><span class="line">    YYWebImageOptionAllowInvalidSSLCertificates = 1 &lt;&lt; 4,</span><br><span class="line">    </span><br><span class="line">    /// Allows background task to download image when app is in background.</span><br><span class="line">    ///app进入后台的时候允许后台下载图片</span><br><span class="line">    YYWebImageOptionAllowBackgroundTask = 1 &lt;&lt; 5,</span><br><span class="line">    </span><br><span class="line">    /// Handles cookies stored in NSHTTPCookieStore.</span><br><span class="line">    ///把cookies存储进NSHTTPCookieStore</span><br><span class="line">    YYWebImageOptionHandleCookies = 1 &lt;&lt; 6,</span><br><span class="line">    </span><br><span class="line">    /// Load the image from remote and refresh the image cache.</span><br><span class="line">    ///从远程下载图片并且刷新图片缓存,这种模式可以用于更换了图片内容,但是图片URL不替换</span><br><span class="line">    YYWebImageOptionRefreshImageCache = 1 &lt;&lt; 7,</span><br><span class="line">    </span><br><span class="line">    /// Do not load image from/to disk cache.</span><br><span class="line">    ///不从硬盘缓存加载图片,同时也不会把图片缓存进磁盘</span><br><span class="line">    YYWebImageOptionIgnoreDiskCache = 1 &lt;&lt; 8,</span><br><span class="line">    </span><br><span class="line">    /// Do not change the view&apos;s image before set a new URL to it.</span><br><span class="line">    ///当没有通过一个URL下载到一个新的图片的时候不去修改图片</span><br><span class="line">    YYWebImageOptionIgnorePlaceHolder = 1 &lt;&lt; 9,</span><br><span class="line">    </span><br><span class="line">    /// Ignore image decoding.</span><br><span class="line">    /// This may used for image downloading without display.</span><br><span class="line">    ///忽略图片解码</span><br><span class="line">    ///这种模式可能用于下载的时候并不去显示该图片</span><br><span class="line">    YYWebImageOptionIgnoreImageDecoding = 1 &lt;&lt; 10,</span><br><span class="line">    </span><br><span class="line">    /// Ignore multi-frame image decoding.</span><br><span class="line">    /// This will handle the GIF/APNG/WebP/ICO image as single frame image.</span><br><span class="line">    ///忽略多frame图片解码</span><br><span class="line">    ///这种模式会讲 GIF/APNG/WebP/ICO图片转换为单一frame的图片,开发中如果需求图片固定显示大小,这个模式可能会有用</span><br><span class="line">    YYWebImageOptionIgnoreAnimatedImage = 1 &lt;&lt; 11,</span><br><span class="line">    </span><br><span class="line">    /// Set the image to view with a fade animation.</span><br><span class="line">    /// This will add a &quot;fade&quot; animation on image view&apos;s layer for better user experience.</span><br><span class="line">    ///设置图片的时候带有一个fade的动画效果</span><br><span class="line">    ///会给view&apos;s layer添加一个淡入淡出动画效果来获取更好的用户体验</span><br><span class="line">    YYWebImageOptionSetImageWithFadeAnimation = 1 &lt;&lt; 12,</span><br><span class="line">    </span><br><span class="line">    /// Do not set the image to the view when image fetch complete.</span><br><span class="line">    /// You may set the image manually.</span><br><span class="line">    ///当图片下载完成之前不去设置它</span><br><span class="line">    ///你可以手动设置图片</span><br><span class="line">    YYWebImageOptionAvoidSetImage = 1 &lt;&lt; 13,</span><br><span class="line">    </span><br><span class="line">    /// This flag will add the URL to a blacklist (in memory) when the URL fail to be downloaded,</span><br><span class="line">    /// so the library won&apos;t keep trying.</span><br><span class="line">    ///这种模式会把URL加进黑名单当下载失败的时候,黑名单存储在内存中,所以这种模式不会尝试重复下载</span><br><span class="line">    YYWebImageOptionIgnoreFailedURL = 1 &lt;&lt; 14,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/// Indicated where the image came from.</span><br><span class="line">///用来告诉我们图片来源</span><br><span class="line">typedef NS_ENUM(NSUInteger, YYWebImageFromType) &#123;</span><br><span class="line">    </span><br><span class="line">    /// No value.空</span><br><span class="line">    YYWebImageFromNone = 0,</span><br><span class="line">    </span><br><span class="line">    /// Fetched from memory cache immediately.</span><br><span class="line">    /// If you called &quot;setImageWithURL:...&quot; and the image is already in memory,</span><br><span class="line">    /// then you will get this value at the same call.</span><br><span class="line">    ///立刻从内存中查找图片,如果你调用了&quot;setImageWithURL...&quot;并且图片已经存在于内存,你会从相同的回调里面得到这个值</span><br><span class="line">    YYWebImageFromMemoryCacheFast,</span><br><span class="line">    </span><br><span class="line">    /// Fetched from memory cache. ///从内存中来</span><br><span class="line">    YYWebImageFromMemoryCache,</span><br><span class="line">    </span><br><span class="line">    /// Fetched from disk cache. ///从磁盘中来</span><br><span class="line">    YYWebImageFromDiskCache,</span><br><span class="line">    </span><br><span class="line">    /// Fetched from remote (web or file path).///从远程下载的,可以是web或者一个路径</span><br><span class="line">    YYWebImageFromRemote,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">/// Indicated image fetch complete stage.</span><br><span class="line">///用来告诉我们图片下载的完成度的</span><br><span class="line">typedef NS_ENUM(NSInteger, YYWebImageStage) &#123;</span><br><span class="line">    </span><br><span class="line">    /// Incomplete, progressive image.///未完成,带进度的image</span><br><span class="line">    YYWebImageStageProgress  = -1,</span><br><span class="line">    </span><br><span class="line">    /// Cancelled.///已经取消了</span><br><span class="line">    YYWebImageStageCancelled = 0,</span><br><span class="line">    </span><br><span class="line">    /// Finished (succeed or failed).///已经结束,可能是成功或者失败</span><br><span class="line">    YYWebImageStageFinished  = 1,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> The block invoked in remote image fetch progress.</span><br><span class="line"> </span><br><span class="line"> @param receivedSize Current received size in bytes.</span><br><span class="line"> @param expectedSize Expected total size in bytes (-1 means unknown).</span><br><span class="line"> */</span><br><span class="line">///从远程下载完成过程的回调,参数receivedSize是已经下载的大小,expectedSize是总共大小,因此可以通过receivedSize/expectedSize获得progress,如果expectedSize = -1代表着不知道一共有多大</span><br><span class="line">typedef void(^YYWebImageProgressBlock)(NSInteger receivedSize, NSInteger expectedSize);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> The block invoked before remote image fetch finished to do additional image process.</span><br><span class="line"> </span><br><span class="line"> @discussion This block will be invoked before `YYWebImageCompletionBlock` to give</span><br><span class="line"> you a chance to do additional image process (such as resize or crop). If there&apos;s</span><br><span class="line"> no need to transform the image, just return the `image` parameter.</span><br><span class="line"> </span><br><span class="line"> @example You can clip the image, blur it and add rounded corners with these code:</span><br><span class="line">    ^(UIImage *image, NSURL *url) &#123;</span><br><span class="line">        // Maybe you need to create an @autoreleasepool to limit memory cost.</span><br><span class="line">        image = [image yy_imageByResizeToSize:CGSizeMake(100, 100) contentMode:UIViewContentModeScaleAspectFill];</span><br><span class="line">        image = [image yy_imageByBlurRadius:20 tintColor:nil tintMode:kCGBlendModeNormal saturation:1.2 maskImage:nil];</span><br><span class="line">        image = [image yy_imageByRoundCornerRadius:5];</span><br><span class="line">        return image;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> @param image The image fetched from url.</span><br><span class="line"> @param url   The image url (remote or local file path).</span><br><span class="line"> @return The transformed image.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> 图片从远程下载完成之前会执行这个block,用来执行一些额外的操作</span><br><span class="line"> @discussion 当&apos;YYWebImageCompletionBlock&apos;这个完成度额回调在下载完成之前会执行这个回调用来给你一个机会做一些额外的处理,比如用来修改图片尺寸等.如果这里不需要对图片进行transform处理,只会返回image这一个参数</span><br><span class="line"> @example 你可以裁剪/模糊图片,或者添加一些边角通过以下代码:</span><br><span class="line"> ^(UIImage *image, NSURL *url)&#123;</span><br><span class="line"> //可能你需要创建一个 @autoreleasepool来限制内存开销</span><br><span class="line"> image = [image yy_imageByResizeToSize:CGSizeMake(100, 100) contentMode:UIViewContentModeScaleAspectFill];</span><br><span class="line"> image = [image yy_imageByBlurRadius:20 tintColor:nil tintMode:kCGBlendModeNormal saturation:1.2 maskImage:nil];</span><br><span class="line"> image = [image yy_imageByRoundCornerRadius:5];</span><br><span class="line"> return image;</span><br><span class="line"> &#125;</span><br><span class="line"> */</span><br><span class="line">typedef UIImage *(^YYWebImageTransformBlock)(UIImage *image, NSURL *url);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> The block invoked when image fetch finished or cancelled.</span><br><span class="line"> </span><br><span class="line"> @param image       The image.</span><br><span class="line"> @param url         The image url (remote or local file path).</span><br><span class="line"> @param from        Where the image came from.</span><br><span class="line"> @param error       Error during image fetching.</span><br><span class="line"> @param finished    If the operation is cancelled, this value is NO, otherwise YES.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> 这个block会在当图片下载完成或者取消的时候调用</span><br><span class="line"> </span><br><span class="line"> @param image       The image.</span><br><span class="line"> @param url         图片url,远程或者本地路径</span><br><span class="line"> @param from        图片从哪来,</span><br><span class="line"> @param error       图片下载中的错误</span><br><span class="line"> @param finished    如果请求取消掉了,返回NO,其他是YES</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">typedef void (^YYWebImageCompletionBlock)(UIImage *image, NSURL *url, YYWebImageFromType from, YYWebImageStage stage, NSError *error);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> A manager to create and manage web image operation.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> *  用来创建和管理网络图片任务的管理器,这个类其实就一个作用,管理生成一个YYWebImageOperation实例</span><br><span class="line"> */</span><br><span class="line">@interface YYWebImageManager : NSObject</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> Returns global YYWebImageManager instance.</span><br><span class="line"> </span><br><span class="line"> 不需要多解释,返回单例类</span><br><span class="line"> @return YYWebImageManager shared instance.</span><br><span class="line"> */</span><br><span class="line">+ (instancetype)sharedManager;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> Creates a manager with an image cache and operation queue.</span><br><span class="line"> </span><br><span class="line"> @param cache  Image cache used by manager (pass nil to avoid image cache).</span><br><span class="line"> @param queue  The operation queue on which image operations are scheduled and run</span><br><span class="line">                (pass nil to make the new operation start immediately without queue).</span><br><span class="line"> @return A new manager.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> *  生成一个manager,带有缓存与操作队列</span><br><span class="line"> *</span><br><span class="line"> *  @param cache 图片缓存用到的manager,</span><br><span class="line"> *  @param queue 图片请求,调度运行的请求队列</span><br><span class="line"> *</span><br><span class="line"> *  @return 一个新的manager</span><br><span class="line"> */</span><br><span class="line">- (instancetype)initWithCache:(YYImageCache *)cache queue:(NSOperationQueue *)queue NS_DESIGNATED_INITIALIZER;</span><br><span class="line"></span><br><span class="line">- (instancetype)init UNAVAILABLE_ATTRIBUTE;</span><br><span class="line">+ (instancetype)new UNAVAILABLE_ATTRIBUTE;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> Creates and returns a new image operation, the operation will start immediately.</span><br><span class="line"> </span><br><span class="line"> @param url        The image url (remote or local file path).</span><br><span class="line"> @param options    The options to control image operation.</span><br><span class="line"> @param progress   Progress block which will be invoked on background thread (pass nil to avoid).</span><br><span class="line"> @param transform  Transform block which will be invoked on background thread  (pass nil to avoid).</span><br><span class="line"> @param completion Completion block which will be invoked on background thread  (pass nil to avoid).</span><br><span class="line"> @return A new image operation.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> *  创建返回一个新的operation,这个operation会立刻开始执行</span><br><span class="line"> *</span><br><span class="line"> *  @param url        图片url,可以是远程或者本地路径</span><br><span class="line"> *  @param options    控制下载的option</span><br><span class="line"> *  @param progress   进度block,会在后台线程的时候调用,传空的话会禁用此特性</span><br><span class="line"> *  @param transform  进入后台线程会调用此block,传空禁用此block</span><br><span class="line"> *  @param completion 进入后台线程会调用此block,传空禁用此block</span><br><span class="line"> *</span><br><span class="line"> *  @return 一个新的图片operation</span><br><span class="line"> */</span><br><span class="line">- (YYWebImageOperation *)requestImageWithURL:(NSURL *)url</span><br><span class="line">                                     options:(YYWebImageOptions)options</span><br><span class="line">                                    progress:(YYWebImageProgressBlock)progress</span><br><span class="line">                                   transform:(YYWebImageTransformBlock)transform</span><br><span class="line">                                  completion:(YYWebImageCompletionBlock)completion;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> The image cache used by image operation. </span><br><span class="line"> You can set it to nil to avoid image cache.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> *  图片请求用到的缓存,可以设置为nil来禁用缓存</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, strong) YYImageCache *cache;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> The operation queue on which image operations are scheduled and run.</span><br><span class="line"> You can set it to nil to make the new operation start immediately without queue.</span><br><span class="line"> </span><br><span class="line"> You can use this queue to control maximum number of concurrent operations, to obtain </span><br><span class="line"> the status of the current operations, or to cancel all operations in this manager.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> *  图片的请求调度运行的队列</span><br><span class="line">    你不通过队列新建一个新的operation的时候可以给这个值置为nil</span><br><span class="line">    </span><br><span class="line">    你可以用这个队列来控制请求的最大值最小值,获得当前操作队列的状态值,或者来取消这个manager中所有的operation</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, strong) NSOperationQueue *queue;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> The shared transform block to process image. Default is nil.</span><br><span class="line"> </span><br><span class="line"> When called `requestImageWithURL:options:progress:transform:completion` and</span><br><span class="line"> the `transform` is nil, this block will be used.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> *  默认值为nil,共享的图片变换的过程,</span><br><span class="line">    当调用`requestImageWithURL:options:progress:transform:completion`并且`transform`为nil时,这个block才有用</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, copy) YYWebImageTransformBlock sharedTransformBlock;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> The image request timeout interval in seconds. Default is 15.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> *  请求超时时间,默认15秒</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, assign) NSTimeInterval timeout;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> The username used by NSURLCredential, default is nil.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> *  NSURLCredential使用的用户名,默认为nil</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, strong) NSString *username;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> The password used by NSURLCredential, default is nil.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> *  同上,密码,默认为nil</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, strong) NSString *password;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> The image HTTP request header. Default is &quot;Accept:image/webp,image/\*;q=0.8&quot;.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> *  图片TTTP的请求头,默认是&quot;Accept:image/webp,image/\*;q=0.8&quot;</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, copy) NSDictionary *headers;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> A block which will be invoked for each image HTTP request to do additional</span><br><span class="line"> HTTP header process. Default is nil.</span><br><span class="line"> </span><br><span class="line"> Use this block to add or remove HTTP header field for a specified URL.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> *  每个图片http请求做额外的HTTP header操作的时候会调用这个block,默认为nil</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, copy) NSDictionary *(^headersFilter)(NSURL *url, NSDictionary *header);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> A block which will be invoked for each image operation. Default is nil.</span><br><span class="line"> </span><br><span class="line"> Use this block to provide a custom image cache key for a specified URL.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> *  每个图片的操作都会调用这个block,默认为nil</span><br><span class="line">    使用这个block能够给URL提供一个自定义的的图片</span><br><span class="line"> */</span><br><span class="line">@property (nonatomic, copy) NSString *(^cacheKeyFilter)(NSURL *url);</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> Returns the HTTP headers for a specified URL.</span><br><span class="line"> </span><br><span class="line"> @param url A specified URL.</span><br><span class="line"> @return HTTP headers.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> *  返回URL的HTTP headers</span><br><span class="line"> *</span><br><span class="line"> *  @param url 当前URL</span><br><span class="line"> *</span><br><span class="line"> *  @return http header</span><br><span class="line"> */</span><br><span class="line">- (NSDictionary *)headersForURL:(NSURL *)url;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> Returns the cache key for a specified URL.</span><br><span class="line"> </span><br><span class="line"> @param url A specified URL</span><br><span class="line"> @return Cache key used in YYImageCache.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> *  给URL返回一个cacheKey</span><br><span class="line"> *</span><br><span class="line"> *  @param url 该URL</span><br><span class="line"> *</span><br><span class="line"> *  @return cache key在YYImageCache中有用到</span><br><span class="line"> */</span><br><span class="line">- (NSString *)cacheKeyForURL:(NSURL *)url;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> Increments the number of active network requests.</span><br><span class="line"> If this number was zero before incrementing, this will start animating the</span><br><span class="line"> status bar network activity indicator.</span><br><span class="line"> </span><br><span class="line"> This method is thread safe.</span><br><span class="line"> </span><br><span class="line"> This method has no effect in App Extension.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> *  增加活跃的网络请求数量</span><br><span class="line">    如果在增加前数量为0,那么会在状态来开始有一个网络菊花动画</span><br><span class="line">    该方法是线程安全的</span><br><span class="line">    该方法不会对APP扩展产生影响</span><br><span class="line"> */</span><br><span class="line">+ (void)incrementNetworkActivityCount;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> Decrements the number of active network requests.</span><br><span class="line"> If this number becomes zero after decrementing, this will stop animating the</span><br><span class="line"> status bar network activity indicator.</span><br><span class="line"> </span><br><span class="line"> This method is thread safe.</span><br><span class="line"> </span><br><span class="line"> This method has no effect in App Extension.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> *  与上面对应,减少活跃的网络请求数量,如果执行完毕之后数量变为0,那么会停止在状态栏的网络指示器动画</span><br><span class="line">    线程安全</span><br><span class="line">    不会影响APP扩展</span><br><span class="line"> */</span><br><span class="line">+ (void)decrementNetworkActivityCount;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> Get current number of active network requests.</span><br><span class="line"> </span><br><span class="line"> This method is thread safe.</span><br><span class="line"> </span><br><span class="line"> This method has no effect in App Extension.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> *  获取当前活跃的网络请求数量</span><br><span class="line"> *  线程安全</span><br><span class="line">    不会影响APP扩展</span><br><span class="line"> *  @return</span><br><span class="line"> */</span><br><span class="line">+ (NSInteger)currentNetworkActivityCount;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure></p>
<p>实现文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#import &quot;YYWebImageManager.h&quot;</span><br><span class="line">#import &quot;YYImageCache.h&quot;</span><br><span class="line">#import &quot;YYWebImageOperation.h&quot;</span><br><span class="line">#import &lt;objc/runtime.h&gt;</span><br><span class="line"></span><br><span class="line">#define kNetworkIndicatorDelay (1/30.0)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/// Returns nil in App Extension.</span><br><span class="line">static UIApplication *_YYSharedApplication() &#123;</span><br><span class="line">    static BOOL isAppExtension = NO;</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        Class cls = NSClassFromString(@&quot;UIApplication&quot;);</span><br><span class="line">        if(!cls || ![cls respondsToSelector:@selector(sharedApplication)]) isAppExtension = YES;</span><br><span class="line">        if ([[[NSBundle mainBundle] bundlePath] hasSuffix:@&quot;.appex&quot;]) isAppExtension = YES;</span><br><span class="line">    &#125;);</span><br><span class="line">#pragma clang diagnostic push</span><br><span class="line">#pragma clang diagnostic ignored &quot;-Wundeclared-selector&quot;</span><br><span class="line">    return isAppExtension ? nil : [UIApplication performSelector:@selector(sharedApplication)];</span><br><span class="line">#pragma clang diagnostic pop</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@interface _YYWebImageApplicationNetworkIndicatorInfo : NSObject</span><br><span class="line">@property (nonatomic, assign) NSInteger count;</span><br><span class="line">@property (nonatomic, strong) NSTimer *timer;</span><br><span class="line">@end</span><br><span class="line">@implementation _YYWebImageApplicationNetworkIndicatorInfo</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation YYWebImageManager</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> *  单例类</span><br><span class="line">    在生成的时候会生成一个YYImageCache单例类,会新建一个NSOperationQueue</span><br><span class="line"> *</span><br><span class="line"> *  @return &lt;#return value description#&gt;</span><br><span class="line"> */</span><br><span class="line">+ (instancetype)sharedManager &#123;</span><br><span class="line">    static YYWebImageManager *manager;</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        YYImageCache *cache = [YYImageCache sharedCache];</span><br><span class="line">        NSOperationQueue *queue = [NSOperationQueue new];</span><br><span class="line">        if ([queue respondsToSelector:@selector(setQualityOfService:)]) &#123;</span><br><span class="line">            queue.qualityOfService = NSQualityOfServiceBackground;</span><br><span class="line">        &#125;</span><br><span class="line">        manager = [[self alloc] initWithCache:cache queue:queue];</span><br><span class="line">    &#125;);</span><br><span class="line">    return manager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (instancetype)init &#123;</span><br><span class="line">    @throw [NSException exceptionWithName:@&quot;YYWebImageManager init error&quot; reason:@&quot;Use the designated initializer to init.&quot; userInfo:nil];</span><br><span class="line">    return [self initWithCache:nil queue:nil];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> *  构造方法,本单例类生成的时候会调用这个方法,传入两个参数,一个缓存,一个队列</span><br><span class="line"> *</span><br><span class="line"> *</span><br><span class="line"> *  @return &lt;#return value description#&gt;</span><br><span class="line"> */</span><br><span class="line">- (instancetype)initWithCache:(YYImageCache *)cache queue:(NSOperationQueue *)queue&#123;</span><br><span class="line">    self = [super init];</span><br><span class="line">    if (!self) return nil;</span><br><span class="line">    //这里很好的遵循了苹果规范,初始化的时候先调用父类,同时初始化了_cache,_queue,_timeout,_header这些属性</span><br><span class="line">    _cache = cache;</span><br><span class="line">    _queue = queue;</span><br><span class="line">    _timeout = 15.0;</span><br><span class="line">    _headers = @&#123; @&quot;Accept&quot; : @&quot;image/webp,image/*;q=0.8&quot; &#125;;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> *  这里就是具体的下载请求方法了</span><br><span class="line"> *</span><br><span class="line"> *  @param url        图片URL</span><br><span class="line"> *  @param options    加载模式</span><br><span class="line"> *  @param progress   进度</span><br><span class="line"> *  @param transform  下载完成前对图片进行操作形变的block</span><br><span class="line"> *  @param completion 下载完成的block</span><br><span class="line"> *</span><br><span class="line"> *  @return 一个YYWebImageOperation对象</span><br><span class="line"> */</span><br><span class="line">- (YYWebImageOperation *)requestImageWithURL:(NSURL *)url</span><br><span class="line">                                     options:(YYWebImageOptions)options</span><br><span class="line">                                    progress:(YYWebImageProgressBlock)progress</span><br><span class="line">                                   transform:(YYWebImageTransformBlock)transform</span><br><span class="line">                                  completion:(YYWebImageCompletionBlock)completion &#123;</span><br><span class="line">    </span><br><span class="line">    //1.先生成一个request,并且根据传入参数生成request参数</span><br><span class="line">    NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:url];</span><br><span class="line">    request.timeoutInterval = _timeout;</span><br><span class="line">    request.HTTPShouldHandleCookies = (options &amp; YYWebImageOptionHandleCookies) != 0;</span><br><span class="line">    //设置请求头</span><br><span class="line">    request.allHTTPHeaderFields = [self headersForURL:url];</span><br><span class="line">    request.HTTPShouldUsePipelining = YES;</span><br><span class="line">    //设置缓存策略,如果加载图片模式存在并且 =YYWebImageOptionUseNSURLCache,使用NSURLRequestUseProtocolCachePolicy策略,否则的话使用NSURLRequestReloadIgnoringLocalCacheData</span><br><span class="line">    //说明:NSURLRequestUseProtocolCachePolicy这个是系统默认的缓存策略,缓存不存在,就去重新服务端拉去,如果存在的话,根据下一步请求的Cache-control字段来进行下一步的操作,比如如果cache-control = must-revalidata,那么还会去询问服务端是否有数据更新,有的话就拉取新数据,没有就返回缓存</span><br><span class="line">    //    NSURLRequestReloadIgnoringLocalCacheData:忽略本地缓存,每次都去请求服务端</span><br><span class="line">    request.cachePolicy = (options &amp; YYWebImageOptionUseNSURLCache) ?</span><br><span class="line">        NSURLRequestUseProtocolCachePolicy : NSURLRequestReloadIgnoringLocalCacheData;</span><br><span class="line">    </span><br><span class="line">    //2.根据request,option,cache,cacheKey,progress,transformblock,completionblock生成一个YYWebImageOperation对象</span><br><span class="line">    YYWebImageOperation *operation = [[YYWebImageOperation alloc] initWithRequest:request</span><br><span class="line">                                                                          options:options</span><br><span class="line">                                                                            cache:_cache</span><br><span class="line">                                                                         cacheKey:[self cacheKeyForURL:url]</span><br><span class="line">                                                                         progress:progress</span><br><span class="line">                                                                        transform:transform ? transform : _sharedTransformBlock</span><br><span class="line">                                                                       completion:completion];</span><br><span class="line">    //如果有用户名跟密码,operation的credential属性通过系统提供的NSURLCredential类生成</span><br><span class="line">    if (_username &amp;&amp; _password) &#123;</span><br><span class="line">        operation.credential = [NSURLCredential credentialWithUser:_username password:_password persistence:NSURLCredentialPersistenceForSession];</span><br><span class="line">    &#125;</span><br><span class="line">    //如果operation初始化成功</span><br><span class="line">    if (operation) &#123;</span><br><span class="line">        NSOperationQueue *queue = _queue;</span><br><span class="line">        //并且存在一个queue</span><br><span class="line">        if (queue) &#123;</span><br><span class="line">            //就把生成的operation添加到队列中</span><br><span class="line">            [queue addOperation:operation];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">        //如果queue不存在,直接开始这个operation</span><br><span class="line">            [operation start];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return operation;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> *  设置请求头的方法</span><br><span class="line">    可以看出在每一步操作的时候都进行了判空处理,这对于第三方库来说尤为重要,因为不知道使用者会怎么非法的调用你的api</span><br><span class="line"> *</span><br><span class="line"> *  @param url &lt;#url description#&gt;</span><br><span class="line"> *</span><br><span class="line"> *  @return &lt;#return value description#&gt;</span><br><span class="line"> */</span><br><span class="line">- (NSDictionary *)headersForURL:(NSURL *)url &#123;</span><br><span class="line">    if (!url) return nil;</span><br><span class="line">    //如果有_headersFilter这个blcok就把url跟_headers传递回去并且返回这个block,没有的返回_headers</span><br><span class="line">    return _headersFilter ? _headersFilter(url, _headers) : _headers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> *  生成cackeKey的方法</span><br><span class="line"> *</span><br><span class="line"> *  如果这个cacheKeyFilterblock存在的话,就把url作为参数传入block并且返回这个block,_cacheKeyFilter这个block的返回值为NSString类型,</span><br><span class="line">    反之如果不存在的话直接以url的完整地址作为key</span><br><span class="line"> *</span><br><span class="line"> *  @return cacheKey字符串</span><br><span class="line"> */</span><br><span class="line">- (NSString *)cacheKeyForURL:(NSURL *)url &#123;</span><br><span class="line">    if (!url) return nil;</span><br><span class="line">    return _cacheKeyFilter ? _cacheKeyFilter(url) : url.absoluteString;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> *  以下是网络状态指示器部分的代码</span><br><span class="line"> */</span><br><span class="line">#pragma mark Network Indicator</span><br><span class="line"></span><br><span class="line">+ (_YYWebImageApplicationNetworkIndicatorInfo *)_networkIndicatorInfo &#123;</span><br><span class="line">    return objc_getAssociatedObject(self, @selector(_networkIndicatorInfo));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (void)_setNetworkIndicatorInfo:(_YYWebImageApplicationNetworkIndicatorInfo *)info &#123;</span><br><span class="line">    objc_setAssociatedObject(self, @selector(_networkIndicatorInfo), info, OBJC_ASSOCIATION_RETAIN);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> *  设置网络状态,默认1/30秒会加载一次</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">+ (void)_delaySetActivity:(NSTimer *)timer &#123;</span><br><span class="line">    UIApplication *app = _YYSharedApplication();</span><br><span class="line">    if (!app) return;</span><br><span class="line">    </span><br><span class="line">    NSNumber *visiable = timer.userInfo;</span><br><span class="line">    if (app.networkActivityIndicatorVisible != visiable.boolValue) &#123;</span><br><span class="line">        [app setNetworkActivityIndicatorVisible:visiable.boolValue];</span><br><span class="line">    &#125;</span><br><span class="line">    [timer invalidate];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> *  修改数量</span><br><span class="line"> *</span><br><span class="line"> *  @param delta &lt;#delta description#&gt;</span><br><span class="line"> */</span><br><span class="line">+ (void)_changeNetworkActivityCount:(NSInteger)delta &#123;</span><br><span class="line">    if (!_YYSharedApplication()) return;</span><br><span class="line">    </span><br><span class="line">    //定义一个无参无反block,在这个block中操作计数加减</span><br><span class="line">    void (^block)() = ^&#123;</span><br><span class="line">        _YYWebImageApplicationNetworkIndicatorInfo *info = [self _networkIndicatorInfo];</span><br><span class="line">        if (!info) &#123;</span><br><span class="line">            info = [_YYWebImageApplicationNetworkIndicatorInfo new];</span><br><span class="line">            [self _setNetworkIndicatorInfo:info];</span><br><span class="line">        &#125;</span><br><span class="line">        NSInteger count = info.count;</span><br><span class="line">        count += delta;</span><br><span class="line">        info.count = count;</span><br><span class="line">        [info.timer invalidate];//这里紧紧销毁计时器,不置nil会不会销毁失败?</span><br><span class="line">        //每1/30秒执行一次timer,同时把info.count作为参数传递过去,</span><br><span class="line">        //其实这里有个思考,初始化就调度这个NSTimer,设置repeats属性为YES,不需要每次增加网络数量跟减少活跃数量的时候都新初始化这个timer,需要发起的时候调用setFireDate来执行开始与停止定时器工作,岂不是效率更高?</span><br><span class="line">        info.timer = [NSTimer timerWithTimeInterval:kNetworkIndicatorDelay target:self selector:@selector(_delaySetActivity:) userInfo:@(info.count &gt; 0) repeats:NO];</span><br><span class="line">        [[NSRunLoop mainRunLoop] addTimer:info.timer forMode:NSRunLoopCommonModes];</span><br><span class="line">    &#125;;</span><br><span class="line">    //如果在主线程,调用block</span><br><span class="line">    if ([NSThread isMainThread]) &#123;</span><br><span class="line">        block();</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        //如果不在,获取主线程调用block</span><br><span class="line">        dispatch_async(dispatch_get_main_queue(), block);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> *  增加活跃网络数量</span><br><span class="line"> */</span><br><span class="line">+ (void)incrementNetworkActivityCount &#123;</span><br><span class="line">    [self _changeNetworkActivityCount:1];</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> *  减少</span><br><span class="line"> */</span><br><span class="line">+ (void)decrementNetworkActivityCount &#123;</span><br><span class="line">    [self _changeNetworkActivityCount:-1];</span><br><span class="line">&#125;</span><br><span class="line">/**</span><br><span class="line"> *  获取当前的活跃请求数量</span><br><span class="line"> *</span><br><span class="line"> *  @return &lt;#return value description#&gt;</span><br><span class="line"> */</span><br><span class="line">+ (NSInteger)currentNetworkActivityCount &#123;</span><br><span class="line">    _YYWebImageApplicationNetworkIndicatorInfo *info = [self _networkIndicatorInfo];</span><br><span class="line">    return info.count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure></p>
<p><del>其实有个疑问在注释里面也写出来了,每次调用<code>+ (void)incrementNetworkActivityCount</code>与<code>+ (void)decrementNetworkActivityCount</code>方法的时候都会新起一个<code>NSTimer</code>,然后再在合适的时间销毁,这样做会不会增加额外的内存开销呢?假如定义一个全局的<code>NSTimer</code>,这样只需要通过<code>setFireDate</code>来控制开启与关闭定时器,岂不更好?</del><br>附上原作者对上述疑问回复<br><img src="/content/images/2015/12/8FDD6A84-B469-4A4D-8B9C-6DAE86547031.png" alt=""></p>
<p><strong>总结</strong>  </p>
<ol>
<li>代码规范. 从注释,到变量名,方法名,枚举的定义,可以看到一个好的开源项目其代码一定是让人读起来赏心悦目的.  </li>
<li>容错处理.因为你不可能知道使用者会如何非法的使用你的api,所以要尽可能做更多的容错处理,最常见的情况就是判空的操作.</li>
<li>注意线程安全,如在<code>+ (void)_changeNetworkActivityCount:(NSInteger)delta</code>中,确保在主线程设置网络指示器的状态.</li>
</ol>
<p>PS:<br><a href="https://github.com/ibireme/YYWebImage" target="_blank" rel="noopener">YYWebImage源码地址</a><br><a href="https://github.com/crossPQW/YYWebImage" target="_blank" rel="noopener">我fork下来添加注释的版本github地址</a></p>

    
	</div>
	<footer class="entry-footer">
		<div class="entry-meta-footer">
			<span class="category">
				
			</span>
			<span class="tags">
				
			</span>
		</div>
	</footer>
	
    
<nav id="article-nav">
  
    <a href="/2015/12/15/读码笔记-YYWebImage源码 (二) -YYWebImageOperation/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          读码笔记-YYWebImage源码 (二) -YYWebImageOperation.md
        
      </div>
    </a>
  
  
    <a href="/2015/10/16/iOS9 快速适配Tips/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">
        
          iOS9 快速适配Tips
        
      </div>
    </a>
  
</nav>

  
</article>




    </div>
    <div class="mb-search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:yoursite.com">
  </form>
</div>
<footer id="footer">
	<h1 class="footer-blog-title">
		<a href="/">crossPQW</a>
	</h1>
	<span class="copyright">
		&copy; 2017 黄少华<br>
		Modify from <a href="http://sanographix.github.io/tumblr/apollo/" target="_blank">Apollo</a> theme, designed by <a href="http://www.sanographix.net/" target="_blank">SANOGRAPHIX.NET</a><br>
		Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
	</span>
</footer>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
  </div>
</body>
</html>